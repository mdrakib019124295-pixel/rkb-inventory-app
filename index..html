<!DOCTYPE html>  
<html lang="bn">  
<head>  
  <meta charset="UTF-8" />  
  <title>üè™ RKB ‡¶∏‡ßç‡¶ü‡ßã‡¶∞</title>  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <script src="https://cdn.tailwindcss.com"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>  
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:50; }  
    @media print {  
      body * { visibility: hidden; }  
      .printable, .printable * { visibility: visible; }  
      .printable { position: absolute; left: 0; top: 0; width: 100%; }  
    }  
    /* Scanner styles */
    #scanner-container {
        position: fixed;
        inset: 0;
        background: black;
        z-index: 100;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    #scanner-viewport {
        width: 100%;
        max-width: 500px;
        height: 300px;
        position: relative;
    }
    #scanner-viewport canvas, #scanner-viewport video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .drawingBuffer {
        position: absolute;
        top: 0;
        left: 0;
    }
    .barcode-feedback {
        color: white;
        margin-top: 10px;
        font-weight: bold;
    }
    .hidden-by-default { display: none; } /* Custom class for sensitive input hiding */
    .locked-field {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }
    /* >>>>>> ‡¶è‡¶ñ‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá <<<<<< */
    .category-button.active {
        background-color: #dc2626; /* bg-red-600 */
        color: white;
        border-color: #dc2626; /* Add border color for better look */
    }
    .category-button:not(.active) {
        background-color: white;
        color: #4b5563; /* text-gray-700 */
        border: 1px solid #d1d5db; /* Default border */
    }
  </style>  
</head>  
<body class="bg-gray-100 min-h-screen flex justify-center py-4">  
  <div class="max-w-3xl w-full bg-white rounded-2xl shadow-lg p-5">  
    <h2 class="text-2xl font-bold mb-4 text-center">üè™ RKB ‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h2>  
    
    <div class="flex items-center gap-3 mb-3">
        <input id="searchInput" type="text" placeholder="üîç ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="flex-grow border p-2 rounded-lg" />
        <div id="secretToggleContainer" class="flex items-center space-x-2 relative">
            <button id="secretToggleButton" class="bg-red-600 text-white p-2 rounded-lg font-semibold text-xl transition-colors" title="‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡ßü ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®/‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®">üîí</button>
            
            <div id="inlinePasswordForm" class="absolute right-0 top-12 bg-white border p-3 rounded-lg shadow-xl hidden z-10 w-64">
                <p class="text-sm font-semibold mb-2 text-center text-red-600">‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®</p>
                <input id="togglePasswordInput" type="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full border p-2 rounded-lg mb-2 text-center" />
                <button id="togglePasswordSubmit" class="w-full bg-green-600 text-white p-2 rounded-lg font-semibold">‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button id="togglePasswordCancel" class="w-full bg-gray-400 text-white p-2 rounded-lg font-semibold mt-1">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <p class="text-xs text-gray-400 mt-2 text-center">‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡ßü‡¶§‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶á‡¶ô‡ßç‡¶ó‡¶ø‡¶§ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶≤‡ßã ‡¶®‡¶æ‡•§</p>
            </div>
        </div>
    </div>

    <div class="mb-4 p-2 bg-gray-100 rounded-lg">
        <h4 class="font-bold mb-2 text-sm text-indigo-700">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶§‡ßà‡¶∞‡¶ø:</h4>
        <div class="grid grid-cols-4 gap-2">
            <input id="newCategoryNameInput" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®" class="border p-2 rounded-lg col-span-3" />
            <button type="button" id="addNewCategoryButton" class="bg-indigo-600 text-white p-2 rounded-lg font-semibold">‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
    <div id="categoryFilterContainer" class="flex flex-wrap gap-2 mb-4 p-2 bg-gray-100 rounded-lg">
        </div>
    <form id="addProductForm" class="grid grid-cols-3 gap-3 mb-4 border-b pb-4">  
      <input id="productName" placeholder="‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ" class="border p-2 rounded-lg col-span-3" />  
      <select id="productCategory" class="border p-2 rounded-lg col-span-3">
          <option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶® --</option>
          </select>
      
      <div class="col-span-1 hidden-by-default" data-secret="true">
        <input id="productCost" type="number" placeholder="‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶¶‡¶æ‡¶Æ (‡ß≥)" class="border p-2 rounded-lg w-full locked-field" data-role="cost" readonly /> 
      </div>
      <input id="productPrice" type="number" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ (‡ß≥)" class="border p-2 rounded-lg" />  
      <div class="col-span-1 hidden-by-default" data-secret="true">
        <input id="profitRate" type="number" placeholder="‡¶≤‡¶æ‡¶≠ (‡ß≥)" class="border p-2 rounded-lg w-full locked-field" data-role="profit" readonly />  
      </div>
      <input id="productBarcode" placeholder="‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="col-span-2 border p-2 rounded-lg" />
      <button type="button" id="scanNewBarcode" class="bg-gray-500 text-white p-2 rounded-lg font-semibold">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      <button type="submit" class="col-span-3 bg-green-600 text-white p-2 rounded-lg font-semibold">‚ûï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>  
    </form>  

    <div class="border-t pt-3 mb-4">
      <h3 class="font-bold mb-2">üì• ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó/‡¶¨‡¶ø‡ßü‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Æ‡¶ú‡ßÅ‡¶¶)</h3>
      <div class="grid grid-cols-4 gap-2">
          <button type="button" id="scanStockBarcode" class="bg-green-700 text-white p-2 rounded-lg col-span-4 font-semibold">‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ø‡ßã‡¶ó/‡¶¨‡¶ø‡ßü‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
      <form id="updateStockForm" class="grid grid-cols-4 gap-2 mt-2">
        <select id="stockProductIndex" class="border p-2 rounded-lg col-span-2">
          <option value="">-- ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶® --</option>
          </select>
        <input id="stockQuantity" type="number" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ï‡ßá‡¶ú‡¶ø/‡¶™‡¶ø‡¶õ)" class="border p-2 rounded-lg" />
        <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg font-semibold">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
      </form>
      <p class="text-xs text-gray-500 mt-1">‡¶ï‡ßá‡¶ú‡¶ø/‡¶™‡¶ø‡¶∏ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡¶®‡•§ ‡¶¨‡¶ø‡ßü‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶ã‡¶£‡¶æ‡¶§‡ßç‡¶Æ‡¶ï (-) ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§</p>
    </div>
    <div class="border-t pt-3 mb-4">
        <button type="button" id="scanSellBarcode" class="bg-blue-700 text-white p-2 rounded-lg w-full font-semibold">üì∑ ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
    <div id="productList" class="space-y-2 mb-4"></div>  

    <div class="border-t pt-3 grid grid-cols-3 gap-2 text-center mb-4">  
      <div class="bg-gray-100 p-2 rounded-lg"><p>‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶æ‡¶≤</p><h3 id="totalQty" class="font-bold">0</h3></div>  
      <div class="bg-gray-100 p-2 rounded-lg"><p>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p><h3 id="totalSell" class="font-bold">‡ß≥0</h3></div>  
      <div class="bg-gray-100 p-2 rounded-lg hidden-by-default" data-secret="true">
        <p>‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠</p><h3 id="totalProfit" class="font-bold text-green-600">‡ß≥0</h3>
      </div>  
    </div>  

    <div class="border-t pt-3 mb-4">  
      <h3 class="font-bold mb-2">üë§ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</h3>  
      <div class="grid grid-cols-3 gap-2">  
        <input id="custName" placeholder="‡¶®‡¶æ‡¶Æ" class="border p-2 rounded-lg" />  
        <input id="custPhone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤" class="border p-2 rounded-lg" />  
        <input id="custAddr" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="border p-2 rounded-lg" />  
      </div>  
    </div>  

    <div class="border-t pt-3 mb-4">  
      <h3 class="font-bold mb-2">üí∞ ‡¶¨‡¶ø‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø</h3>  
      <div class="grid grid-cols-3 gap-2">  
        <input id="discountInput" type="number" placeholder="‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü (‡ß≥)" class="border p-2 rounded-lg" />  
        <input id="paidInput" type="number" placeholder="‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ (‡ß≥)" class="border p-2 rounded-lg" />  
        <input id="dueInput" type="number" placeholder="‡¶¨‡¶æ‡¶ï‡¶ø (‡ß≥)" class="border p-2 rounded-lg bg-gray-100" readonly />  
      </div>  
    </div>  

    <div class="flex justify-between mb-4">  
      <button id="createMemo" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">üßæ ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶§‡ßà‡¶∞‡¶ø</button>  
      <button id="clearQty" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold">üîÑ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>  
      <div class="flex gap-2">
        <button id="openPasswordModal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hidden-by-default" data-secret="true">üîë ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
        <button id="openReport" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hidden-by-default" data-secret="true">üìà ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø</button>
      </div>
    </div>  

    <div id="memoArea" class="hidden border rounded-lg p-3 mb-4 bg-gray-50 printable"></div>  

    <div class="border-t pt-3">  
      <h3 class="font-bold mb-2">üóÇÔ∏è ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø (‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º)</h3>  
      <div id="memoHistory" class="space-y-2"></div>  
      <button id="showPermanentHistory" class="bg-gray-600 text-white px-3 py-1 rounded-lg font-semibold mt-3 hidden-by-default" data-secret="true">üóìÔ∏è ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
    </div>

  </div>    <div id="editModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-md p-4 shadow-lg">  
      <h3 class="text-lg font-bold mb-2">‡¶™‡¶£‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßã</h3>  
      <div class="space-y-2">  
        <input id="editName" class="border p-2 rounded w-full" placeholder="‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ" />  
        <select id="editCategory" class="border p-2 rounded w-full">
            </select>
        <input id="editCost" type="number" class="border p-2 rounded w-full locked-field" placeholder="‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶¶‡¶æ‡¶Æ (‡ß≥)" data-secret="true" data-role="cost" readonly /> 
        <input id="editPrice" type="number" class="border p-2 rounded w-full" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ (‡ß≥)" />  
        <input id="editProfit" type="number" class="border p-2 rounded w-full locked-field" placeholder="‡¶≤‡¶æ‡¶≠ (‡ß≥)" data-secret="true" data-role="profit" readonly />  
      </div>  
      <div class="flex justify-end gap-2 mt-4">  
        <button id="cancelEdit" class="px-3 py-1 rounded bg-gray-200">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>  
        <button id="saveEdit" class="px-3 py-1 rounded bg-blue-600 text-white">‡¶∏‡ßá‡¶≠</button>  
      </div>  
    </div>  
  </div>  
  
  <div id="reportModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-lg p-4 shadow-lg overflow-y-auto max-h-[90vh]">  
      <h3 class="text-xl font-bold mb-2 text-center border-b pb-2">üìà ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶ì ‡¶≤‡¶æ‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>  
      <div id="reportContent" class="space-y-4">
          </div>
      <div class="flex justify-end mt-4">  
        <button id="closeReport" class="px-3 py-1 rounded bg-gray-200">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>  
      </div>  
    </div>  
  </div>
  <div id="passwordModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-sm p-5 shadow-lg">  
      <h3 class="text-xl font-bold mb-4 text-center">üîë ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h3>  
      <div class="space-y-3">  
        <input id="currentPassword" type="password" class="border p-3 rounded w-full" placeholder="‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®" />  
        <input id="newPassword" type="password" class="border p-3 rounded w-full" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶® (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß™ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" />  
        <input id="confirmPassword" type="password" class="border p-3 rounded w-full" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" />  
      </div>  
      <div class="flex justify-end gap-2 mt-4">  
        <button id="cancelPasswordChange" class="px-4 py-2 rounded bg-gray-400 text-white font-semibold">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>  
        <button id="saveNewPassword" class="px-4 py-2 rounded bg-green-600 text-white font-semibold">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>  
      </div>  
    </div>  
  </div>
  <div id="scanner-container">
      <div id="scanner-viewport"></div>
      <p id="barcode-feedback" class="barcode-feedback">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ß‡¶∞‡ßÅ‡¶®...</p>
      <button id="closeScanner" class="mt-4 bg-red-600 text-white p-2 rounded-lg font-semibold">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
  </div>
  <div id="permanentHistoryModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-lg p-4 shadow-lg overflow-y-auto max-h-[90vh]">  
      <h3 class="text-xl font-bold mb-2 text-center border-b pb-2">üóìÔ∏è ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ (‡ßß ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá)</h3>  
      <div id="permanentMemoHistory" class="space-y-2"></div>
      <p class="text-xs text-red-500 mt-4 text-center">‡¶è‡¶á ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡ßß ‡¶¨‡¶õ‡¶∞ ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
      <div class="flex justify-end mt-4">  
        <button id="closePermanentHistoryModal" class="px-3 py-1 rounded bg-gray-200">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>  
      </div>  
    </div>  
  </div>
  
  <script>  
  // DOM refs  
  const productList = document.getElementById('productList');  
  const totalQty = document.getElementById('totalQty');  
  const totalSell = document.getElementById('totalSell');  
  const totalProfit = document.getElementById('totalProfit'); 
  const searchInput = document.getElementById('searchInput');  
  
  const memoArea = document.getElementById('memoArea');  
  const memoHistoryDiv = document.getElementById('memoHistory'); // Renamed to avoid conflict
  
  const discountInput = document.getElementById('discountInput');  
  const paidInput = document.getElementById('paidInput');  
  const dueInput = document.getElementById('dueInput');  

  const reportModal = document.getElementById('reportModal');
  const reportContent = document.getElementById('reportContent');
  const stockProductIndex = document.getElementById('stockProductIndex'); 
  const productBarcodeInput = document.getElementById('productBarcode'); 
  const productCategoryInput = document.getElementById('productCategory'); 
  const categoryFilterContainer = document.getElementById('categoryFilterContainer'); 
  // NEW DOM REFS for category creation
  const newCategoryNameInput = document.getElementById('newCategoryNameInput');
  const addNewCategoryButton = document.getElementById('addNewCategoryButton');
  
  const productCostInput = document.getElementById('productCost'); 
  const profitRateInput = document.getElementById('profitRate'); 
  
  const editModal = document.getElementById('editModal');  
  const editName = document.getElementById('editName');  
  const editCategory = document.getElementById('editCategory'); 
  const editCost = document.getElementById('editCost'); 
  const editPrice = document.getElementById('editPrice');  
  const editProfit = document.getElementById('editProfit'); 
  const saveEdit = document.getElementById('saveEdit');  
  const cancelEdit = document.getElementById('cancelEdit');  

  // Barcode Scanner DOM
  const scannerContainer = document.getElementById('scanner-container');
  const barcodeFeedback = document.getElementById('barcode-feedback');
  let scannerMode = null; 

  // Password Toggle DOM
  const secretToggleButton = document.getElementById('secretToggleButton');
  const inlinePasswordForm = document.getElementById('inlinePasswordForm');
  const togglePasswordInput = document.getElementById('togglePasswordInput');
  const togglePasswordSubmit = document.getElementById('togglePasswordSubmit');
  const togglePasswordCancel = document.getElementById('togglePasswordCancel');

  // Password Change Modal DOM Refs
  const passwordModal = document.getElementById('passwordModal');
  const currentPasswordInput = document.getElementById('currentPassword');
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const saveNewPasswordButton = document.getElementById('saveNewPassword');
  const cancelPasswordChangeButton = document.getElementById('cancelPasswordChange');
  const openPasswordModalButton = document.getElementById('openPasswordModal');
  
  // NEW Permanent History Modal DOM Refs
  const showPermanentHistoryButton = document.getElementById('showPermanentHistory');
  const permanentHistoryModal = document.getElementById('permanentHistoryModal');
  const permanentMemoHistoryDiv = document.getElementById('permanentMemoHistory');

  
  // storage  
  let products = JSON.parse(localStorage.getItem('products')) || [];  
  let memos = JSON.parse(localStorage.getItem('memos')) || []; // Active memos
  let memoHistory = JSON.parse(localStorage.getItem('memoHistory')) || []; // Permanent history
  let serial = parseInt(localStorage.getItem('memoSerial')) || 1001;
  let expenses = JSON.parse(localStorage.getItem('expenses')) || []; 
  let editingIndex = null;  
  let currentMemo = null;  

  // NEW: Current selected category filter (default to 'all')
  let currentCategoryFilter = 'all';
  
  // Define default categories 
  const DEFAULT_CATEGORIES = {
      'grocery': '‡¶ó‡ßç‡¶∞‡ßã‡¶∏‡¶æ‡¶∞‡¶ø',
      'electronic': '‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï',
      'other': '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'
  };


  // SECRETS & AUTHENTICATION
  // Load password from localStorage, default to '1234'
  let SECRET_PASSWORD = localStorage.getItem('appPassword') || '1234'; 
  
  function savePassword(newPass) {
      SECRET_PASSWORD = newPass;
      localStorage.setItem('appPassword', newPass);
  }

  // Ensure initial default password is saved for persistence
  if (localStorage.getItem('appPassword') === null) {
      savePassword('1234');
  }

  // Load initial state for persistent unlock
  let secretsVisible = localStorage.getItem('secretsVisible') === 'true'; 

  function saveSecretsState() {
      localStorage.setItem('secretsVisible', secretsVisible);
  }

  function updateSecretsVisibility() {
      // 1. Toggle visibility of secret fields (using data-secret="true")
      document.querySelectorAll('[data-secret="true"]').forEach(el => {
          if (secretsVisible) {
              el.classList.remove('hidden-by-default');
          } else {
              el.classList.add('hidden-by-default');
          }
      });

      // 2. Toggle locked styles and readonly for secret inputs (cost/profit)
      document.querySelectorAll('[data-role="cost"], [data-role="profit"]').forEach(el => {
          if (secretsVisible) {
              el.classList.remove('locked-field');
              el.readOnly = false;
          } else {
              el.classList.add('locked-field');
              el.readOnly = true;
          }
      });

      // 3. Update the toggle button icon and color
      secretToggleButton.textContent = secretsVisible ? 'üîì' : 'üîí';
      secretToggleButton.classList.toggle('bg-red-600', !secretsVisible);
      secretToggleButton.classList.toggle('bg-green-600', secretsVisible);
      
      // 4. Re-render dependent components
      renderProducts(searchInput.value); 
      renderHistory(memos, memoHistoryDiv, 'active'); // Render active memos
      updateSummary();
      saveSecretsState();
  }

  // Event listener for the main toggle button (Lock/Unlock)
  secretToggleButton.addEventListener('click', () => {
      if (secretsVisible) {
          // Current state: UNLOCKED -> Action: LOCK
          if (confirm("‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) {
              secretsVisible = false;
              inlinePasswordForm.classList.add('hidden');
              updateSecretsVisibility();
              alert("üîí ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§");
          }
      } else {
          // Current state: LOCKED -> Action: SHOW PASSWORD PROMPT
          inlinePasswordForm.classList.toggle('hidden');
          togglePasswordInput.value = '';
          togglePasswordInput.focus();
      }
  });

  // Event listener for inline password submission
  togglePasswordSubmit.addEventListener('click', () => {
      if (togglePasswordInput.value === SECRET_PASSWORD) { // Uses SECRET_PASSWORD variable
          secretsVisible = true;
          inlinePasswordForm.classList.add('hidden');
          updateSecretsVisibility();
          alert("üîì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï‡•§ ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§");
      } else {
          alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
          togglePasswordInput.value = '';
          togglePasswordInput.focus();
      }
  });
  togglePasswordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        togglePasswordSubmit.click();
    }
  });

  // Event listener for inline password cancellation
  togglePasswordCancel.addEventListener('click', () => {
      inlinePasswordForm.classList.add('hidden');
  });
  
  // Password Change Modal Logic
  openPasswordModalButton.addEventListener('click', () => {
      if (secretsVisible) {
          passwordModal.classList.remove('hidden');
          currentPasswordInput.value = '';
          newPasswordInput.value = '';
          confirmPasswordInput.value = '';
          currentPasswordInput.focus();
      } else {
          alert("üîë ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
      }
  });
  
  cancelPasswordChangeButton.addEventListener('click', () => {
      passwordModal.classList.add('hidden');
  });
  
  passwordModal.addEventListener('click', (ev) => {
      if (ev.target === passwordModal) passwordModal.classList.add('hidden');
  });

  saveNewPasswordButton.addEventListener('click', () => {
      const current = currentPasswordInput.value;
      const newPass = newPasswordInput.value;
      const confirmPass = confirmPasswordInput.value;

      if (current !== SECRET_PASSWORD) {
          alert("‚ö†Ô∏è ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§");
          currentPasswordInput.focus();
          return;
      }

      if (newPass.length < 4) {
          alert("‚ö†Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß™ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
          newPasswordInput.focus();
          return;
      }

      if (newPass !== confirmPass) {
          alert("‚ö†Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶ï‡¶∞‡¶£ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ‡•§");
          confirmPasswordInput.focus();
          return;
      }

      // Success: Save the new password
      savePassword(newPass); // Save to variable and localStorage
      passwordModal.classList.add('hidden');
      alert("‚úÖ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§");
      
      // As a safety measure, automatically lock the system after changing the password
      secretsVisible = false;
      updateSecretsVisibility();
  });


  // helpers  
  function saveProducts(){ localStorage.setItem('products', JSON.stringify(products)); }  
  function saveMemos(){ localStorage.setItem('memos', JSON.stringify(memos)); } // Active Memos
  function saveMemoHistory(){ localStorage.setItem('memoHistory', JSON.stringify(memoHistory)); } // Permanent History
  function saveSerial(){ localStorage.setItem('memoSerial', serial); }  
  function saveExpenses(){ localStorage.setItem('expenses', JSON.stringify(expenses)); } 
  function fmt(n){ return Number(n||0).toFixed(2); }  
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }  

  // NEW: Helper to format category name for display
  function formatCategoryName(key) {
      // Use the key itself if no specific mapping is found.
      if (key === 'grocery') return '‡¶ó‡ßç‡¶∞‡ßã‡¶∏‡¶æ‡¶∞‡¶ø';
      if (key === 'electronic') return '‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï';
      if (key === 'other') return '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø';
      return key; 
  }

  // Helper to get all unique category keys, including defaults
  function getAllCategories() {
      const categories = new Set();
      // Add default categories
      Object.keys(DEFAULT_CATEGORIES).forEach(key => categories.add(key));

      // Add categories from products (including custom ones)
      products.forEach(p => {
          if (p.category) categories.add(p.category);
      });
      // Remove dummy category names if they exist as keys
      categories.forEach(c => {
        if (c.startsWith('__CATEGORY_')) categories.delete(c);
      })
      return Array.from(categories).sort();
  }

  // Helper to populate the Select dropdown in the Add Product and Edit Modal forms
  function populateCategoryDropdowns() {
      const allCategories = getAllCategories();
      
      // 1. Add Product Form Dropdown
      productCategoryInput.innerHTML = '<option value="">-- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶® --</option>';
      allCategories.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = formatCategoryName(key);
          productCategoryInput.appendChild(option);
      });

      // 2. Edit Modal Dropdown
      editCategory.innerHTML = '';
      allCategories.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = formatCategoryName(key);
          editCategory.appendChild(option);
      });
  }

  // NEW: Logic for adding a new category
  addNewCategoryButton.addEventListener('click', addNewCategory);

  function addNewCategory() {
      const newCategoryName = newCategoryNameInput.value.trim();

      if (!newCategoryName) {
          alert('‚ö†Ô∏è ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§');
          return;
      }
      
      const lowerCaseName = newCategoryName.toLowerCase();
      
      // Check for existing categories
      const existingCategories = getAllCategories().map(c => c.toLowerCase());
      if (existingCategories.includes(lowerCaseName) || Object.values(DEFAULT_CATEGORIES).map(c => c.toLowerCase()).includes(lowerCaseName)) {
          alert(`‚ö†Ô∏è "${newCategoryName}" ‡¶®‡¶æ‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶Ü‡¶õ‡ßá ‡¶¨‡¶æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§`);
          return;
      }
      
      // To ensure the category is available for filtering and dropdowns, 
      // we must add at least one dummy product with that category.
      const isNewCategory = !products.some(p => p.category && p.category.toLowerCase() === lowerCaseName);

      if (isNewCategory) {
        products.push({ 
            name: `__CATEGORY_${newCategoryName}__`, // Dummy name to prevent accidental selling
            category: newCategoryName, 
            costPrice: 0, 
            price: 0, 
            profitRate: 0, 
            barcode: null, 
            kg: 0, 
            pc: 0, 
            stock: 0 
        }); 
        saveProducts();
      }

      newCategoryNameInput.value = '';
      alert(`‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø "${newCategoryName}" ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
      
      // Re-render everything to update dropdowns and filter buttons
      renderProducts(searchInput.value); 
  }

  // Expense Logging Logic (unchanged)
  function getCategoryName(key) {
      switch(key) {
          case 'personal': return '‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ñ‡¶∞‡¶ö';
          case 'family': return '‡¶™‡¶æ‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö';
          case 'store': return '‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö';
          case 'withdrawal': return '‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶§‡ßã‡¶≤‡¶æ';
          default: return '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö';
      }
  }

  function handleExpenseSubmission(e) {
      e.preventDefault();
      const category = document.getElementById('expenseCategory').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const description = document.getElementById('expenseDescription').value.trim();

      if (!category || category === '') {
          alert('‚ö†Ô∏è ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶®‡•§');
          return;
      }
      if (isNaN(amount) || amount <= 0) {
          alert('‚ö†Ô∏è ‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®‡•§');
          return;
      }

      const expense = {
          id: Date.now(),
          date: new Date().toISOString(), 
          category,
          amount,
          description
      };

      expenses.push(expense);
      saveExpenses();
      e.target.reset();
      
      renderReports(); 
      
      alert(`‚úÖ ${getCategoryName(category)} (${fmt(amount)} ‡ß≥) ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
  }
  
  function deleteExpense(id) {
    if(confirm('‡¶è‡¶á ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
        expenses = expenses.filter(x => x.id !== id);
        saveExpenses();
        renderReports(); // Re-render the report modal
    }
  }

  function generateDailyExpenseHtml() {
      // Expense logging form HTML
      const expenseFormHtml = `
          <h4 class="font-bold mb-2 text-xl text-red-700">üí∏ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h4>
          <form id="addExpenseFormModal" class="grid grid-cols-4 gap-2 border p-3 rounded-lg bg-red-50">
              <select id="expenseCategory" class="border p-2 rounded-lg col-span-2" required>
                  <option value="">-- ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶® --</option>
                  <option value="personal">‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ñ‡¶∞‡¶ö</option>
                  <option value="family">‡¶™‡¶æ‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö</option>
                  <option value="store">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</option>
                  <option value="withdrawal">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶§‡ßã‡¶≤‡¶æ</option>
              </select>
              <input id="expenseAmount" type="number" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)" class="border p-2 rounded-lg" required />
              <button type="submit" class="bg-red-600 text-white p-2 rounded-lg font-semibold">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
              <input id="expenseDescription" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="col-span-4 border p-2 rounded-lg" />
          </form>
      `;

      // Daily history logic
      const today = new Date().toISOString().substring(0, 10);
      const dailyExpenses = expenses.filter(e => e.date.startsWith(today)).reverse();
      let total = 0;
      
      let historyHtml = '<h4 class="font-bold mb-2 mt-4 text-xl">üìÖ ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h4><div id="expenseHistoryInModal" class="space-y-2">';

      if (dailyExpenses.length === 0) {
          historyHtml += '<p class="text-center text-gray-500">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶®‡ßá‡¶á‡•§</p>';
      } else {
          dailyExpenses.forEach(e => {
              total += e.amount;
              historyHtml += `
                  <div class="border p-2 rounded flex justify-between items-center bg-white shadow-sm">
                      <div>
                          <p class="font-semibold text-sm text-red-700">${getCategoryName(e.category)}: ‡ß≥${fmt(e.amount)}</p>
                          <p class="text-xs text-gray-500">${e.description ? escapeHtml(e.description) : '‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶®‡ßá‡¶á'}</p>
                      </div>
                      <button class="text-red-500 hover:text-red-700 text-lg delete-expense-in-modal" data-id="${e.id}" title="‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®">‚ùå</button>
                  </div>
              `;
          });
      }

      historyHtml += '</div>';
      historyHtml += `<div class="flex justify-between items-center mt-2 pt-2 border-t border-dashed">
              <span class="font-bold text-lg">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö:</span>
              <span id="totalDailyExpenseInModal" class="font-bold text-xl text-red-700">‡ß≥${fmt(total)}</span>
          </div>`;

      return `<div class="border p-4 rounded-lg bg-gray-50 mt-4 space-y-4">${expenseFormHtml}${historyHtml}</div>`;
  }
  // END Expense Logging Logic

  // Barcode Scanner Functions (unchanged logic)
  function startScanner(mode) {
    scannerMode = mode;
    scannerContainer.style.display = 'flex';
    barcodeFeedback.textContent = '‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ß‡¶∞‡ßÅ‡¶®...';

    Quagga.init({
        inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector('#scanner-viewport'),
            constraints: {
                facingMode: "environment" // Use back camera
            }
        },
        decoder : {
            readers : ["ean_reader","upc_reader","code_128_reader"] // Common barcode types
        },
        locate: true
    }, function(err) {
        if (err) {
            console.error(err);
            barcodeFeedback.textContent = '‚ö†Ô∏è ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + err.message;
            return
        }
        Quagga.start();
        Quagga.onDetected(onBarcodeDetected);
    });
  }

  function stopScanner() {
    Quagga.stop();
    scannerContainer.style.display = 'none';
    scannerMode = null;
  }

  function onBarcodeDetected(result) {
    const code = result.codeResult.code;
    // Find product based on barcode, ignoring dummy category products
    const existingProduct = products.find(p => p.barcode === code && !p.name.startsWith('__CATEGORY_'));
    const existingProductIndex = products.findIndex(p => p.barcode === code && !p.name.startsWith('__CATEGORY_'));
    
    barcodeFeedback.textContent = `‚úÖ ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${code}`;
    
    // Stop the scanner immediately
    stopScanner(); 

    if (scannerMode === 'add_product') {
        productBarcodeInput.value = code;
    } else if (scannerMode === 'add_stock') {
        if (!existingProduct) {
            alert(`‚ö†Ô∏è ‡¶è‡¶á ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° (${code}) ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá '‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®' ‡¶´‡¶∞‡ßç‡¶Æ‡ßá ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
            return;
        }
        // Use Product Name as the value for the dropdown
        stockProductIndex.value = existingProduct.name; 
        document.getElementById('stockQuantity').value = 1; 
        alert(`‚úÖ ${existingProduct.name} ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§`);

    } else if (scannerMode === 'sell') {
        if (!existingProduct) {
            alert(`‚ö†Ô∏è ‡¶è‡¶á ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° (${code}) ‡¶è‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§`);
            return;
        }
        const i = existingProductIndex;
        changePc(i, 1);
        alert(`‚úÖ ${existingProduct.name} (‡ßß ‡¶™‡¶ø‡¶õ) ‡¶Æ‡ßá‡¶Æ‡ßã‡¶§‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
    }
  }

  // Barcode Scanner Event Listeners
  document.getElementById('scanNewBarcode').addEventListener('click', () => startScanner('add_product'));
  document.getElementById('scanStockBarcode').addEventListener('click', () => startScanner('add_stock'));
  document.getElementById('scanSellBarcode').addEventListener('click', () => startScanner('sell'));
  document.getElementById('closeScanner').addEventListener('click', stopScanner);


  // render  
  function renderProducts(filter=''){  
    productList.innerHTML = '';  
    
    // Filter out dummy products
    const realProducts = products.filter(p => !p.name.startsWith('__CATEGORY_'));

    // Filter by Search Text
    // IMPORTANT: When creating the filtered array, attach the original index (__i) 
    // for use in button listeners (edit/delete/changeKg/changePc)
    const filteredBySearch = realProducts.map((p,i)=>({...p,
        __i:products.findIndex(pr => pr.name === p.name) // Find original index in 'products' array
    })).filter(p => 
      p.name.toLowerCase().includes(filter.toLowerCase()) || 
      (p.barcode && p.barcode.includes(filter))
    );  

    // Filter by Category
    const filtered = filteredBySearch.filter(p => {
        if (currentCategoryFilter === 'all') return true;
        // Use default categories if not explicitly set (e.g. legacy products)
        const pCategory = p.category ? p.category.toLowerCase() : 'other'; 
        return pCategory === currentCategoryFilter.toLowerCase(); // Use lower case for comparison
    });

    if(!filtered.length){ productList.innerHTML = '<p class="text-center text-gray-500">‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶®‡ßá‡¶á</p>'; updateSummary(); populateStockDropdown(); populateCategoryDropdowns(); updateCategoryButtons(); return; }  
  
    filtered.forEach(p=>{  
      const i = p.__i;  // Use the original index
      const div = document.createElement('div');  
      div.className = 'border p-3 rounded-lg bg-gray-50 flex items-center justify-between';  
      
      // Conditionally render secret buttons and data based on 'secretsVisible'
      const isVisible = secretsVisible;
      const editButtonHtml = isVisible ? 
          `<button class="text-blue-600 font-semibold text-sm edit-product" data-i="${i}">‚úèÔ∏è</button>` : 
          `<button class="text-gray-400 font-semibold text-sm view-only" data-i="${i}" title="‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®">‚úèÔ∏è</button>`;
      const deleteButtonHtml = isVisible ?
          `<button class="text-red-600 font-semibold text-sm delete-product" data-i="${i}">üóëÔ∏è</button>` : '';

      const secretDataHtml = isVisible ?
          `‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶¶‡¶æ‡¶Æ: ‡ß≥${fmt(p.costPrice||0)} | ‡¶≤‡¶æ‡¶≠: ‡ß≥${fmt(p.profitRate)} |` : '';

      div.innerHTML = `  
        <div class="flex items-center gap-3">
          <div>
              <div class="flex items-center gap-3 mb-1">
                  <h3 class="font-semibold">${escapeHtml(p.name)} <span class="text-xs font-normal text-indigo-500">(${formatCategoryName(p.category || 'other')})</span></h3>
                  ${editButtonHtml}
                  ${deleteButtonHtml}
              </div>
              <p class="text-xs text-gray-400">‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°: ${p.barcode || '‡¶®‡ßá‡¶á'}</p>
              <p class="text-sm text-gray-500">
                ${secretDataHtml}
                ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ: ‡ß≥${fmt(p.price)} | 
                **‡¶Æ‡¶ú‡ßÅ‡¶¶: ${fmt(p.stock||0)}**
              </p>
          </div>
        </div>
  
        <div class="flex items-center gap-3">  
          <div class="text-center">  
            <button class="bg-red-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="kgDec" data-i="${i}">‚àí</button>  
            <div class="mx-2 font-bold text-xl" id="kg-${i}">${fmt(p.kg||0)}</div>  
            <button class="bg-green-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="kgInc" data-i="${i}">+</button>  
            <div class="text-xs text-gray-500 text-center">‡¶ï‡ßá‡¶ú‡¶ø</div>  
          </div>  
          <div class="text-center">  
            <button class="bg-red-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="pcDec" data-i="${i}">‚àí</button>  
            <div class="mx-2 font-bold text-xl" id="pc-${i}">${p.pc||0}</div>  
            <button class="bg-green-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="pcInc" data-i="${i}">+</button>  
            <div class="text-xs text-gray-500 text-center">‡¶™‡¶ø‡¶õ</div>  
          </div>  
        </div>  
      `;  
      productList.appendChild(div);  
    });  
  
    // attach delegated listeners
    productList.querySelectorAll('[data-action="kgInc"]').forEach(b => b.addEventListener('click', e => changeKg(e.currentTarget.dataset.i, 0.25)));  
    productList.querySelectorAll('[data-action="kgDec"]').forEach(b => b.addEventListener('click', e => changeKg(e.currentTarget.dataset.i, -0.25)));  
    productList.querySelectorAll('[data-action="pcInc"]').forEach(b => b.addEventListener('click', e => changePc(e.currentTarget.dataset.i, 1)));  
    productList.querySelectorAll('[data-action="pcDec"]').forEach(b => b.addEventListener('click', e => changePc(e.currentTarget.dataset.i, -1)));  
    
    // Protected action listeners
    productList.querySelectorAll('.edit-product').forEach(b => b.addEventListener('click', e => openEditModal(parseInt(e.currentTarget.dataset.i))));  
    productList.querySelectorAll('.delete-product').forEach(b => b.addEventListener('click', e => deleteProduct(parseInt(e.currentTarget.dataset.i))));  
    // Listener for view-only edit button (prompts for unlock)
    productList.querySelectorAll('.view-only').forEach(b => b.addEventListener('click', e => {
      alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
    }));
  
    updateSummary();  
    populateStockDropdown();
    populateCategoryDropdowns(); // IMPORTANT: Update dropdowns whenever products change
    updateCategoryButtons(); 
  }  

  // NEW: Category Filter Logic (Slightly improved for better visual update)
  function updateCategoryButtons() {
      // 1. Clear all buttons 
      categoryFilterContainer.innerHTML = '';
      
      // 2. Identify all unique categories (including defaults and custom ones)
      const categories = getAllCategories();
      
      // The list of categories to display in the filter, including 'all'
      const filterCategories = ['all', ...categories];

      // 3. Add all buttons to the container
      filterCategories.forEach(category => {
          const btn = document.createElement('button');
          btn.className = 'category-button px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200';
          btn.textContent = category === 'all' ? '‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø' : formatCategoryName(category);
          btn.dataset.category = category;
          
          // Apply active state if it matches the current filter
          if (category === currentCategoryFilter) {
              btn.classList.add('active');
          } else {
              // Apply default style when not active
              btn.classList.add('bg-white', 'text-gray-700', 'border');
          }
          
          categoryFilterContainer.appendChild(btn);
      });
  }

  // Delegated listener for category buttons
  categoryFilterContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.category-button');
      if (btn) {
          const newCategory = btn.dataset.category;
          if (newCategory !== currentCategoryFilter) {
              currentCategoryFilter = newCategory;
              // Reset search input when changing category
              searchInput.value = ''; 
              renderProducts(); // Re-render to show filtered products
          } else {
              // If the same category is clicked, no need to re-render, but ensure visuals are correct
              updateCategoryButtons();
          }
      }
  });


  // Stock Management Logic (MODIFIED)
  function populateStockDropdown(){
      stockProductIndex.innerHTML = '<option value="">-- ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶® --</option>';
      products.filter(p => !p.name.startsWith('__CATEGORY_')).forEach((p, i) => { // Filter dummy products
          const option = document.createElement('option');
          // *** FIX: Use product name as the value (since indices can shift due to filtering/dummys)
          option.value = p.name; 
          // Include category in dropdown for better visibility
          option.textContent = `${p.name} (${formatCategoryName(p.category || 'other')}, ‡¶Æ‡¶ú‡ßÅ‡¶¶: ${fmt(p.stock||0)})`;
          stockProductIndex.appendChild(option);
      });
  }
  
  document.getElementById('updateStockForm').addEventListener('submit', e => {
      e.preventDefault();
      // *** FIX: Get the product name (value) from the dropdown
      const productName = stockProductIndex.value; 
      const qty = parseFloat(document.getElementById('stockQuantity').value);
  
      // *** FIX: Find the product in the main 'products' array by name
      const product = products.find(p => p.name === productName); 
      const productIndex = products.findIndex(p => p.name === productName); // For clarity in console/debug

      if (!product || isNaN(qty) || qty === 0) {
          alert('‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®‡•§');
          return;
      }
      
      product.stock = (product.stock || 0) + qty;
      
      if (product.stock < 0) {
        alert(`‚ö†Ô∏è ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ã‡¶£‡¶æ‡¶§‡ßç‡¶Æ‡¶ï ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï: ${fmt(product.stock)}`);
      }
  
      saveProducts();
      e.target.reset();
      renderProducts(searchInput.value); // Re-render to show updated stock
      alert(`‚úÖ ${product.name} ‡¶è‡¶∞ ‡¶Æ‡¶ú‡ßÅ‡¶¶ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶ú‡ßÅ‡¶¶: ${fmt(product.stock)}`);
  });
  // END Stock Management Logic


  // edit modal functions  
  function openEditModal(index){  
    // Check if secrets are visible/unlocked for editing sensitive fields
    const isVisible = secretsVisible;
    if (!isVisible) {
        alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
        return; 
    } 
    
    editingIndex = index;  
    const p = products[index];  
    
    // Ensure category dropdown is populated before setting value
    populateCategoryDropdowns(); 

    editName.value = p.name || '';  
    editCategory.value = p.category || 'other'; 
    editCost.value = p.costPrice !== undefined ? p.costPrice : ''; 
    editProfit.value = p.profitRate !== undefined ? p.profitRate : '';  
    editPrice.value = p.price !== undefined ? p.price : '';  
    editModal.classList.remove('hidden');  
    editName.focus();  
  }  
  function closeEditModal(){ editingIndex = null; editModal.classList.add('hidden'); }  
  
  saveEdit.addEventListener('click', ()=>{  
    if(editingIndex === null) return closeEditModal();  
    
    const name = editName.value.trim();  
    const category = editCategory.value.trim() || 'other'; 
    const price = parseFloat(editPrice.value); 
    
    if(!name || isNaN(price)){ alert('‡¶®‡¶æ‡¶Æ, ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶ì ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®'); return; }
        
    products[editingIndex].name = name;
    products[editingIndex].category = category; 
    products[editingIndex].price = price;

    if (secretsVisible) {
      // If unlocked, save all fields
      const cost = parseFloat(editCost.value); 
      const profit = parseFloat(editProfit.value);  
      
      if(isNaN(cost)){ alert('‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®'); return; } 
      if(isNaN(profit)){ alert('‡¶∏‡¶†‡¶ø‡¶ï ‡¶≤‡¶æ‡¶≠‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®'); return; }  
      
      products[editingIndex].costPrice = cost; 
      products[editingIndex].profitRate = profit;  
      alert('‚úÖ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá'); 
    } else {
        alert('‚úÖ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶ì ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    }

    saveProducts();
    renderProducts(searchInput.value);  
    updateSummary();  
    closeEditModal();  
  });  
  
  cancelEdit.addEventListener('click', ()=> closeEditModal());  
  editModal.addEventListener('click', (ev)=>{ if(ev.target === editModal) closeEditModal(); });  
  
  // CRUD product helpers  
  function deleteProduct(i){  
    if (!secretsVisible) {
        alert("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
        return;
    }
    // Check if it's a dummy category product
    if (products[i].name.startsWith('__CATEGORY_')) {
        if(!confirm(`‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø-‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶®‡¶ø‡¶ß‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø (${products[i].category}) ‡¶ü‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßÅ‡¶ï‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) return;
    } else if(!confirm('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
        return;
    }
    
    products.splice(i,1);  
    saveProducts();  
    renderProducts(searchInput.value);  
    updateSummary();  
  }  
  
  function changeKg(i, delta){  
    i = parseInt(i);  
    
    const newKg = (products[i].kg||0) + delta;
    
    // Logic to check stock against new quantity 
    if (delta > 0) {
        const currentPc = products[i].pc || 0; 
        const currentStock = products[i].stock || 0;
        const totalSold = newKg + currentPc;
        if (currentStock < totalSold) {
            alert(`‚ö†Ô∏è ${products[i].name} ‡¶è‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®: ${fmt(totalSold)}, ‡¶Æ‡¶ú‡ßÅ‡¶¶: ${fmt(currentStock)}`);
            return; 
        }
    }
    
    products[i].kg = newKg;  
    if(products[i].kg < 0) products[i].kg = 0;  
    saveProducts();  
    document.getElementById(`kg-${i}`).textContent = fmt(products[i].kg);  
    updateSummary(); updateDueAmount();  
  }  
  function changePc(i, delta){  
    i = parseInt(i);  
    
    const newPc = (products[i].pc||0) + delta;
    
    // Logic to check stock against new quantity (pc and kg count towards total stock for simplicity)
    if (delta > 0) {
        const currentKg = products[i].kg || 0; 
        const currentStock = products[i].stock || 0;
        const totalSold = newPc + currentKg;
        if (currentStock < totalSold) {
            alert(`‚ö†Ô∏è ${products[i].name} ‡¶è‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®: ${fmt(totalSold)}, ‡¶Æ‡¶ú‡ßÅ‡¶¶: ${fmt(currentStock)}`);
            return; 
        }
    }

    products[i].pc = newPc;
    if(products[i].pc < 0) products[i].pc = 0;
    
    saveProducts();  
    document.getElementById(`pc-${i}`).textContent = products[i].pc;  
    updateSummary(); updateDueAmount();  
  }  
  
  // summary & bill calculations  
  function updateSummary(){  
    // Filter out dummy products
    const realProducts = products.filter(p => !p.name.startsWith('__CATEGORY_'));

    const totalQtyValue = realProducts.reduce((s,p)=> s + (p.kg||0) + (p.pc||0), 0);  
    const sell = realProducts.reduce((s,p)=> s + ((p.kg||0) * (p.price||0)) + ((p.pc||0) * (p.price||0)), 0);  
    
    // Profit calculation now considers ALL memos (active + history)
    const allMemos = [...memos, ...memoHistory];
    const totalProfitValue = allMemos.reduce((s, m) => s + (m.totalProfit || 0), 0);
    
    totalQty.textContent = fmt(totalQtyValue);  
    totalSell.textContent = '‡ß≥' + fmt(sell);  
    
    // Only update totalProfit if secrets are visible
    if (secretsVisible) {
        totalProfit.textContent = '‡ß≥' + fmt(totalProfitValue);
        totalProfit.parentElement.classList.remove('hidden-by-default');
    } else {
        totalProfit.textContent = '‡ß≥???.??';
        totalProfit.parentElement.classList.add('hidden-by-default');
    }
  }  
  
  function updateDueAmount(){  
    const items = products.filter(p=> (p.kg||0) > 0 || (p.pc||0) > 0);  
    const totalAmount = items.reduce((s,p)=> s + ((p.kg||0) * (p.price||0)) + ((p.pc||0) * (p.price||0)), 0);  
    const discount = parseFloat(discountInput.value) || 0;  
    const paid = parseFloat(paidInput.value) || 0;  
    const grand = totalAmount - discount;  
    const due = grand - paid;  
    dueInput.value = due >= 0 ? fmt(due) : fmt(0);  
  }  
  discountInput.addEventListener('input', updateDueAmount);  
  paidInput.addEventListener('input', updateDueAmount);  
  
  // add product  
  document.getElementById('addProductForm').addEventListener('submit', e=>{  
    e.preventDefault();  
    const name = document.getElementById('productName').value.trim();  
    const price = parseFloat(document.getElementById('productPrice').value);  
    const category = productCategoryInput.value.trim();
    
    if(!category){ alert('‚ö†Ô∏è ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡¶æ‡¶õ‡ßÅ‡¶®‡•§'); return; }
    
    let costPrice = 0;
    let profit = 0;
    
    if (secretsVisible) {
      costPrice = parseFloat(productCostInput.value) || 0; 
      profit = parseFloat(profitRateInput.value) || 0;  
      if (isNaN(costPrice)){ alert('‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶¶‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®'); return; }
    } else {
      // If not authenticated, ensure selling price is valid
      if(isNaN(price) || !name){ alert('‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®'); return; }
    }
    
    const barcode = productBarcodeInput.value.trim() || null;
    
    if(!name || isNaN(price)){ alert('‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¶‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®'); return; }  
    
    // Check for duplicate barcode in real products
    if (barcode && products.some(p => p.barcode === barcode && !p.name.startsWith('__CATEGORY_'))) {
        alert('‚ö†Ô∏è ‡¶è‡¶á ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶Ü‡¶õ‡ßá‡•§');
        return;
    }
    
    // Check for duplicate name in real products
    if (products.some(p => p.name.toLowerCase() === name.toLowerCase() && !p.name.startsWith('__CATEGORY_'))) {
        alert('‚ö†Ô∏è ‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶Ü‡¶õ‡ßá‡•§');
        return;
    }

    products.push({ name, category, costPrice: costPrice, price, profitRate: profit, barcode, kg: 0, pc: 0, stock: 0 }); 
    saveProducts();  
    e.target.reset();  
    renderProducts();  
  });  
  
  // create memo (MODIFIED: Saves to memos, then copies to history upon delete/permanent save)
  document.getElementById('createMemo').addEventListener('click', ()=>{  
    const items = products.filter(p=> (p.kg||0) > 0 || (p.pc||0) > 0);  
    if(items.length === 0){ alert('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®'); return; }  
  
    const totalAmount = items.reduce((s,p)=> s + ((p.kg||0) * p.price) + ((p.pc||0) * p.price), 0);  
    const totalProfit = items.reduce((s,p)=> s + (((p.kg||0) + (p.pc||0)) * (p.profitRate||0)), 0); 
    const discount = parseFloat(discountInput.value) || 0;  
    const paid = parseFloat(paidInput.value) || 0;  
    const due = totalAmount - discount - paid;  

    let deductionSuccessful = true;
    const itemsToDeduct = [];
    for(const item of items) {
        // Find the index of the product by name.
        const index = products.findIndex(p => p.name === item.name); 
        // Stock deduction is based on the total quantity sold (kg + pc)
        const soldQty = (item.kg || 0) + (item.pc || 0);

        if (index === -1) {
             console.warn(`Product "${item.name}" not found during memo creation. Skipping stock deduction.`);
             continue;
        }

        if ((products[index].stock || 0) < soldQty) {
            alert(`‚ö†Ô∏è ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü‡•§ "${item.name}" ‡¶è‡¶∞ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®: ${fmt(soldQty)}, ‡¶Æ‡¶ú‡ßÅ‡¶¶: ${fmt(products[index].stock || 0)}`);
            deductionSuccessful = false;
            break;
        }
        itemsToDeduct.push({ index, soldQty });
    }
    
    if(!deductionSuccessful) return; 
  
    const memo = {  
      id: Date.now(),  
      serial,  
      date: new Date().toLocaleString(),  
      customer: {  
        name: document.getElementById('custName').value || '',  
        phone: document.getElementById('custPhone').value || '',  
        addr: document.getElementById('custAddr').value || ''  
      },  
      items: items.map(p => ({ 
        name: p.name, 
        category: p.category || 'other', 
        kg: p.kg||0, 
        pc: p.pc||0, 
        price: p.price||0, 
        profitRate: p.profitRate || 0, 
        profit: ((p.kg||0) + (p.pc||0)) * (p.profitRate||0) 
      })),  
      total: totalAmount,  
      totalProfit: totalProfit, 
      discount,  
      paid,  
      due,
    };  
  
    memos.push(memo); saveMemos(); serial++; saveSerial();  
  
    // Deduct stock after successful memo creation
    itemsToDeduct.forEach(deduction => {
        products[deduction.index].stock -= deduction.soldQty;
    });

    // Reset selling quantity after memo creation
    products.forEach(p => { p.kg = 0; p.pc = 0; });  
    saveProducts(); 

    document.getElementById('custName').value = '';  
    document.getElementById('custPhone').value = '';  
    document.getElementById('custAddr').value = '';  
    discountInput.value = ''; paidInput.value = ''; dueInput.value = '';  
  
    renderProducts();  
    renderHistory(memos, memoHistoryDiv, 'active');  
    showMemo(memo);  
    alert('üßæ ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ì ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá');  
  });  
  
  // print / pdf functions
  function printMemo(id, isHistory = false){  
    const memoArray = isHistory ? memoHistory : memos;
    const m = memoArray.find(x=> x.id === id);  
    if(!m) return alert('‡¶Æ‡ßá‡¶Æ‡ßã ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø');  
    const w = window.open('', '', 'width=800,height=600');  
    w.document.write('<html><head><title>‡¶Æ‡ßá‡¶Æ‡ßã</title></head><body>');  
    w.document.write(generateMemoInnerHTML(m));  
    w.document.write('</body></html>');  
    w.document.close(); w.focus();  
    setTimeout(()=> { w.print(); w.close(); }, 300);  
  }  
  
  async function pdfMemo(id, isHistory = false){  
    const memoArray = isHistory ? memoHistory : memos;
    const m = memoArray.find(x=> x.id === id);  
    if(!m) return alert('‡¶Æ‡ßá‡¶Æ‡ßã ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø');  
    const container = document.createElement('div');  
    container.style.width = '800px'; container.style.padding='20px'; container.style.background='white';  
    container.innerHTML = generateMemoInnerHTML(m);  
    document.body.appendChild(container);  
    try{  
      const canvas = await html2canvas(container, { scale: 2 });  
      const img = canvas.toDataURL('image/png');  
      const { jsPDF } = window.jspdf;  
      const pdf = new jsPDF({ unit:'pt', format:'a4' });  
      const pdfWidth = pdf.internal.pageSize.getWidth();  
      const imgProps = pdf.getImageProperties(img);  
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;  
      pdf.addImage(img, 'PNG', 0, 0, pdfWidth, pdfHeight);  
      pdf.save(`memo_${m.serial}.pdf`);  
    }catch(err){ console.error(err); alert('PDF ‡¶§‡ßà‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'); }  
    finally{ document.body.removeChild(container); }  
  }  
  
  function generateMemoInnerHTML(m){  
    return `<div style="text-align:center"><h2>üè™ RKB ‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h2><p style="font-size:12px">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ | ‡¶´‡ßã‡¶®: ‡ß¶‡ßß‡ß≠‡ß¶‡ß¶-‡ß¶‡ß¶‡ß¶‡ß¶‡ß¶</p><hr/></div>  
      <div style="font-size:12px;margin-top:6px;"><div><strong>‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç:</strong> ${m.serial}</div><div><strong>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</strong> ${m.date}</div>  
      ${m.customer.name?`<div><strong>‡¶®‡¶æ‡¶Æ:</strong> ${escapeHtml(m.customer.name)}</div>`:''}  
      ${m.customer.phone?`<div><strong>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</strong> ${escapeHtml(m.customer.phone)}</div>`:''}  
      ${m.customer.addr?`<div><strong>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</strong> ${escapeHtml(m.customer.addr)}</div>`:''}</div>  
      <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:12px;">  
        <tr style="background:#f3f3f3"><th style="border:1px solid #ddd;padding:6px">#</th><th style="border:1px solid #ddd;padding:6px">‡¶™‡¶£‡ßç‡¶Ø (‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø)</th><th style="border:1px solid #ddd;padding:6px">‡¶ï‡ßá‡¶ú‡¶ø</th><th style="border:1px solid #ddd;padding:6px">‡¶™‡¶ø‡¶õ</th><th style="border:1px solid #ddd;padding:6px">‡¶¶‡¶æ‡¶Æ</th><th style="border:1px solid #ddd;padding:6px">‡¶Æ‡ßã‡¶ü</th></tr>  
        ${m.items.map((it,idx)=>`<tr><td style="border:1px solid #ddd;padding:6px">${idx+1}</td><td style="border:1px solid #ddd;padding:6px">${escapeHtml(it.name)} (${formatCategoryName(it.category || 'other')})</td><td style="border:1px solid #ddd;padding:6px">${fmt(it.kg)}</td><td style="border:1px solid #ddd;padding:6px">${it.pc}</td><td style="border:1px solid #ddd;padding:6px">‡ß≥${fmt(it.price)}</td><td style="border:1px solid #ddd;padding:6px">‡ß≥${fmt((it.kg*it.price + it.pc*it.price))}</td></tr>`).join('')}  
      </table>  
      <div style="text-align:right;margin-top:8px;font-weight:bold;">‡¶Æ‡ßã‡¶ü: ‡ß≥${fmt(m.total)}</div>  
      <div style="text-align:right;margin-top:2px;">‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${fmt(m.discount)} | ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§: ‡ß≥${fmt(m.paid)} | ‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${fmt(m.due)}</div>  
      <p style="text-align:center;font-size:11px;margin-top:8px;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‚Äî ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶¨‡ßá‡¶® üôè</p>`;  
  }  
  
  // *************************************************************
  // ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Cancel Memo - Restores Stock & Financials - FROM ACTIVE MEMOS)
  // *************************************************************
  function cancelMemo(id){  
      // 1. ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ
      if(!secretsVisible) {
          alert("‚ö†Ô∏è ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
          return;
      }
      
      // 2. ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶ï‡¶∞‡¶£ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ
      if(!confirm('üö® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ (Cancel) ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶§‡ßá "OK" ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§')) return;  
      
      // 3. ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
      const memoIndex = memos.findIndex(m => m.id === id);
      if(memoIndex === -1) {
          alert("‚ö†Ô∏è ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
          return;
      }
      const memoToDelete = memos[memoIndex];

      // 4. ‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ (Restore Stock)
      memoToDelete.items.forEach(item => {
          // *** FIX: Find product by name
          const product = products.find(p => p.name === item.name); 
          if (product) {
              const soldQty = (item.kg || 0) + (item.pc || 0);
              product.stock = (product.stock || 0) + soldQty; 
          } else {
              console.warn(`Product "${item.name}" not found for stock restoration. Stock remains unchanged for this item.`);
          }
      });

      // 5. ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ (‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶Æ‡¶æ‡¶®‡ßá‡¶ì ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ)
      memos.splice(memoIndex, 1);
      
      // 6. ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
      saveProducts();    
      saveMemos();    

      renderHistory(memos, memoHistoryDiv, 'active');           
      renderProducts(searchInput.value); 
      updateSummary();           
      
      if(currentMemo && currentMemo.id === id){ 
          memoArea.classList.add('hidden'); 
          currentMemo = null; 
      }  
      
      alert(`‚úÖ ‡¶Æ‡ßá‡¶Æ‡ßã ${memoToDelete.serial} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶æ‡¶≠-‡¶ï‡ßç‡¶∑‡¶§‡¶ø‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
  }
  
  // *************************************************************
  // ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Delete to Permanent History - NO STOCK RESTORE)
  // *************************************************************
  function deleteToPermanentHistory(id) {
       // 1. ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ
       if(!secretsVisible) {
          alert("‚ö†Ô∏è ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
          return;
      }
      
      // 2. ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶ï‡¶∞‡¶£ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ (Permanent Save)
      if(!confirm('üíæ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø **‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£** ‡¶ï‡¶∞‡ßá ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá‡¶®, ‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶≤‡¶æ‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§')) return;  

      // 3. ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶™‡¶ø ‡¶§‡ßà‡¶∞‡¶ø
      const memoIndex = memos.findIndex(m => m.id === id);
      if(memoIndex === -1) {
          alert("‚ö†Ô∏è ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
          return;
      }
      
      const memoToSave = memos[memoIndex];
      // Note: We move the memo, the profit calculation remains because the profit is calculated from ALL memos (active + history)

      // 4. ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶§‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
      memoHistory.push(memoToSave);
      memos.splice(memoIndex, 1);
      
      // 5. ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
      saveMemos();    
      saveMemoHistory();
      
      renderHistory(memos, memoHistoryDiv, 'active'); // Re-render active memos
      
      if(currentMemo && currentMemo.id === id){ 
          memoArea.classList.add('hidden'); 
          currentMemo = null; 
      }  
      
      alert(`‚úÖ ‡¶Æ‡ßá‡¶Æ‡ßã ${memoToSave.serial} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
  }

  // *************************************************************
  // ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ (Permanent Delete from History)
  // *************************************************************
  function deleteMemoPermanentlyFromHistory(id){  
      if(!confirm('üö® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø **‡¶ö‡¶ø‡¶∞‡¶§‡¶∞‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá** ‡¶ö‡¶æ‡¶®? ‡¶è‡¶∞ ‡¶≤‡¶æ‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá‡¶ì ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶è‡¶á ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§')) return;  
      
      const memoIndex = memoHistory.findIndex(m => m.id === id);
      if(memoIndex === -1) {
          alert("‚ö†Ô∏è ‡¶Æ‡ßá‡¶Æ‡ßã‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
          return;
      }
      const memoToDelete = memoHistory[memoIndex];

      memoHistory.splice(memoIndex, 1);
      
      saveMemoHistory();    
      updateSummary(); // Re-calculate total profit
      renderHistory(memoHistory, permanentMemoHistoryDiv, 'history'); // Re-render the history modal
      
      if(currentMemo && currentMemo.id === id){ 
          memoArea.classList.add('hidden'); 
          currentMemo = null; 
      }  
      
      alert(`‚úÖ ‡¶Æ‡ßá‡¶Æ‡ßã ${memoToDelete.serial} ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
  }

  // show memo (UPDATED to include Cancel and Permanent Save/Delete buttons)
  function showMemo(m, isHistory = false){  
      currentMemo = m;  
      memoArea.classList.remove('hidden');  
      
      // ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® (‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶∏‡¶π - ‡¶∂‡ßÅ‡¶ß‡ßÅ Active Memos-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
      const cancelButtonHtml = !isHistory && secretsVisible ? 
          `<button class="bg-red-500 text-white px-3 py-1 rounded" onclick="cancelMemo(${m.id})">‚Ü©Ô∏è ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ (‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞)</button>` : 
          !isHistory && `<button class="bg-gray-400 text-white px-3 py-1 rounded" title="‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®">üîí ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>`;
          
      // ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶¨‡¶æ‡¶ü‡¶® (‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá - ‡¶∂‡ßÅ‡¶ß‡ßÅ Active Memos-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
      const deleteButtonHtml = !isHistory && secretsVisible ? 
          `<button class="bg-gray-700 text-white px-3 py-1 rounded" onclick="deleteToPermanentHistory(${m.id})">üíæ ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠</button>` : 
          !isHistory && `<button class="bg-gray-400 text-white px-3 py-1 rounded" title="‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®">üîí ‡¶∏‡ßá‡¶≠</button>`;
          
      // ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® (‡¶∂‡ßÅ‡¶ß‡ßÅ Permanent History-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
      const permanentDeleteButtonHtml = isHistory && secretsVisible ?
          `<button class="bg-red-800 text-white px-3 py-1 rounded" onclick="deleteMemoPermanentlyFromHistory(${m.id})">üóëÔ∏è ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü (‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶π)</button>` : '';

      memoArea.innerHTML = `  
        <div class="text-center mb-2">  
          <h3 class="font-bold text-lg">üè™ RKB ‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h3>  
        </div>  
        <div class="text-sm mb-2">  
          ‡¶Æ‡ßá‡¶Æ‡ßã: ${m.serial} | ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${m.date}<br>  
          ${m.customer.name?`‡¶®‡¶æ‡¶Æ: ${escapeHtml(m.customer.name)}<br>`:''}  
          ${m.customer.phone?`‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${escapeHtml(m.customer.phone)}<br>`:''}  
          ${m.customer.addr?`‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ${escapeHtml(m.customer.addr)}`:''}</div>  
        </div>  
        <table class="w-full border-collapse text-sm">  
          <tr class="bg-gray-200"><th class="border p-1">#</th><th class="border p-1">‡¶™‡¶£‡ßç‡¶Ø</th><th class="border p-1">‡¶ï‡ßá‡¶ú‡¶ø</th><th class="border p-1">‡¶™‡¶ø‡¶õ</th><th class="border p-1">‡¶¶‡¶æ‡¶Æ</th><th class="border p-1">‡¶Æ‡ßã‡¶ü</th></tr>  
          ${m.items.map((it,idx)=>`<tr><td class="border p-1 text-center">${idx+1}</td><td class="border p-1">${escapeHtml(it.name)} (${formatCategoryName(it.category || 'other')})</td><td class="border p-1 text-center">${fmt(it.kg)}</td><td class="border p-1 text-center">${it.pc}</td><td class="border p-1 text-right">‡ß≥${fmt(it.price)}</td><td class="border p-1 text-right">‡ß≥${fmt((it.kg*it.price + it.pc*it.price))}</td></tr>`).join('')}  
        </table>  
        <div class="text-right mt-2">  
          <p>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${fmt(m.discount)}</p>  
          <p>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§: ‡ß≥${fmt(m.paid)}</p>  
          <p class="font-bold">‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${fmt(m.due)}</p>  
          <p class="font-bold text-lg mt-1">‡¶Æ‡ßã‡¶ü: ‡ß≥${fmt(m.total)}</p>  
        </div>  
        <div class="flex justify-end gap-2 mt-3">  
          <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="printMemo(${m.id}, ${isHistory})">üñ®Ô∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>  
          <button class="bg-indigo-600 text-white px-3 py-1 rounded" onclick="pdfMemo(${m.id}, ${isHistory})">üìÑ PDF</button>  
          ${cancelButtonHtml || ''}
          ${deleteButtonHtml || ''}
          ${permanentDeleteButtonHtml || ''}
        </div>  
      `;  
      setTimeout(()=> window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 120);  
  }  
    
  // renderHistory ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
  function renderHistory(memoArray, targetDiv, mode){  
      targetDiv.innerHTML = '';  
      
      if(!memoArray.length){ 
          targetDiv.innerHTML = `<p class="text-center text-gray-500">‡¶ï‡ßã‡¶®‡ßã ${mode === 'active' ? '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º' : '‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã'} ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡ßá‡¶á</p>`; 
          return; 
      }  
      
      memoArray.slice().reverse().forEach(m=>{  
        const div = document.createElement('div');  
        div.className = `border p-2 rounded ${mode === 'active' ? 'bg-gray-50' : 'bg-orange-50 border-orange-200'} flex justify-between items-center`;  
        
        const profitDisplay = secretsVisible ? `(‡¶≤‡¶æ‡¶≠: ‡ß≥${fmt(m.totalProfit||0)})` : '';
        const historyText = mode === 'history' ? '(‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã)' : '';
        
        // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶§‡ßà‡¶∞‡¶ø
        const viewButton = document.createElement('button');
        viewButton.className = "bg-blue-600 text-white px-2 py-1 rounded text-xs";
        viewButton.textContent = '‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®';
        viewButton.onclick = ()=> showMemo(m, mode === 'history'); // Pass isHistory flag

        const printButton = document.createElement('button');
        printButton.className = "bg-green-600 text-white px-2 py-1 rounded text-xs";
        printButton.textContent = 'üñ®Ô∏è';
        printButton.onclick = ()=> printMemo(m.id, mode === 'history');

        const pdfButton = document.createElement('button');
        pdfButton.className = "bg-indigo-600 text-white px-2 py-1 rounded text-xs";
        pdfButton.textContent = 'üìÑ';
        pdfButton.onclick = ()=> pdfMemo(m.id, mode === 'history');
        
        // Active Memos-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® (Delete/Restore Stock)
        let actionButton;
        if (mode === 'active') {
             actionButton = document.createElement('button');
             actionButton.className = `bg-red-500 text-white px-2 py-1 rounded text-xs ml-1 ${secretsVisible ? '' : 'hidden'}`;
             actionButton.textContent = '‚Ü©Ô∏è ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤';
             actionButton.onclick = ()=> cancelMemo(m.id);
        } else if (mode === 'history') {
             // Permanent Save/Delete Button for History Memos
             actionButton = document.createElement('button');
             actionButton.className = `bg-red-800 text-white px-2 py-1 rounded text-xs ml-1 ${secretsVisible ? '' : 'hidden'}`;
             actionButton.textContent = 'üóëÔ∏è ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü';
             actionButton.onclick = ()=> deleteMemoPermanentlyFromHistory(m.id);
        }

        div.innerHTML = `<div><p class="font-semibold">‡¶Æ‡ßá‡¶Æ‡ßã ${m.serial} ${historyText} ‚Äî ‡ß≥${fmt(m.total)} ${profitDisplay}</p><p class="text-xs text-gray-500">${m.date}</p></div>  
          <div class="flex gap-2 items-center">  
          </div>`;  
        
        // ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
        const actionContainer = div.querySelector('.flex.gap-2');
        actionContainer.appendChild(viewButton);
        actionContainer.appendChild(printButton);
        actionContainer.appendChild(pdfButton);
        if (actionButton) {
            actionContainer.appendChild(actionButton);
        }

        targetDiv.appendChild(div);  
      });  
  }  
  
  // Permanent History Modal Logic
  showPermanentHistoryButton.addEventListener('click', () => {
      if (secretsVisible) {
          renderHistory(memoHistory, permanentMemoHistoryDiv, 'history');
          permanentHistoryModal.classList.remove('hidden');
      } else {
          alert("‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
      }
  });

  document.getElementById('closePermanentHistoryModal').addEventListener('click', () => permanentHistoryModal.classList.add('hidden'));
  permanentHistoryModal.addEventListener('click', (ev) => {
      if (ev.target === permanentHistoryModal) permanentHistoryModal.classList.add('hidden');
  });
  
  // *************************************************************
  // ‡ßß ‡¶¨‡¶õ‡¶∞ ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (NEW)
  // *************************************************************
  function autoDeleteOldHistory() {
      const oneYearAgo = Date.now() - (365 * 24 * 60 * 60 * 1000); // 1 year in milliseconds
      let deletedCount = 0;

      // Filter out memos older than 1 year
      const newHistory = memoHistory.filter(m => {
          // Parse the date saved in "DD/MM/YYYY, HH:MM:SS PM" format
          // Recreate Date object based on the saved string (assuming it's a valid locale string)
          const memoDate = new Date(m.date);
          
          if (isNaN(memoDate.getTime())) {
              // Fallback for badly formatted dates (keep them if date is invalid)
              return true;
          }
          
          if (memoDate.getTime() < oneYearAgo) {
              deletedCount++;
              return false; // Delete this memo
          }
          return true; // Keep this memo
      });

      if (deletedCount > 0) {
          memoHistory = newHistory;
          saveMemoHistory();
          console.log(`‚úÖ ${deletedCount} ‡¶ü‡¶ø ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡ßß ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã)‡•§`);
          // Optionally, alert the user only if they are logged in
          if (secretsVisible) {
             alert(`‚úÖ ${deletedCount} ‡¶ü‡¶ø ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡ßß ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã)‡•§`);
          }
      }
  }


  // clear all qtys  
  document.getElementById('clearQty').addEventListener('click', ()=> {  
    if(!confirm('‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) return;  
    products.forEach(p=>{ p.kg = 0; p.pc = 0; });  
    document.getElementById('custName').value = '';  
    document.getElementById('custPhone').value = '';  
    document.getElementById('custAddr').value = ''; 
    discountInput.value = ''; paidInput.value = ''; dueInput.value = '';  
    saveProducts(); renderProducts(); updateSummary();  
  });  
  
  // search  
  searchInput.addEventListener('input', e=> renderProducts(e.target.value));  

  // Report Modal Logic (MODIFIED: Profit is calculated from memos + memoHistory)
  document.getElementById('openReport').addEventListener('click', () => {
      // Check if visible
      if (!secretsVisible) {
          alert("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶≤‡¶ï ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
          return;
      } else {
          openReportModal();
      }
  });
  document.getElementById('closeReport').addEventListener('click', () => reportModal.classList.add('hidden'));

  function openReportModal() {
      // This is only called if secrets are visible
      renderReports();
      reportModal.classList.remove('hidden');
      
      // Attach listeners after rendering the report content
      const expenseFormModal = document.getElementById('addExpenseFormModal');
      if (expenseFormModal) {
          expenseFormModal.addEventListener('submit', handleExpenseSubmission);
      }
      
      document.querySelectorAll('.delete-expense-in-modal').forEach(b => {
          b.addEventListener('click', (e) => {
              const id = parseInt(e.currentTarget.dataset.id);
              deleteExpense(id); // Use the refactored delete function
          });
      });
  }

  function renderReports() {
      // Get all memos for comprehensive reporting
      const allMemos = [...memos, ...memoHistory];
      
      // **1. Expense Logging Form and Daily History**
      let expenseLoggingAndDailyHistory = generateDailyExpenseHtml();
      
      // Filter out dummy products from report
      const realProducts = products.filter(p => !p.name.startsWith('__CATEGORY_'));

      // 2. Inventory Report 
      let inventoryHtml = '<h4 class="font-bold text-lg border-b pb-1">‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶Æ‡¶ú‡ßÅ‡¶¶)</h4>';
      inventoryHtml += '<ul class="list-disc list-inside space-y-1 text-sm">';
      const inStock = realProducts.filter(p => p.stock > 0).sort((a,b)=> a.name.localeCompare(b.name));
      if (inStock.length > 0) {
          inventoryHtml += inStock.map(p => {
              // Always render secret info here as this function is only called when secretsVisible is true
              const secretText = secretsVisible ? 
                  ` (<span class="text-red-700">‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶¶‡¶æ‡¶Æ: ‡ß≥${fmt(p.costPrice||0)}</span> | ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ: ‡ß≥${fmt(p.price)} | ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶≤‡¶æ‡¶≠: ‡ß≥${fmt(p.profitRate)})` :
                  ` (‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶¶‡¶æ‡¶Æ: ‡ß≥${fmt(p.price)})`; 
              return `<li>**${escapeHtml(p.name)}** (${formatCategoryName(p.category || 'other')}, ‡¶Æ‡¶ú‡ßÅ‡¶¶): **${fmt(p.stock)}** ‡¶á‡¶â‡¶®‡¶ø‡¶ü${secretText}</li>`;
          }).join('');
      } else {
          inventoryHtml += '<li>‚ö†Ô∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡¶ú‡ßÅ‡¶§ ‡¶®‡ßá‡¶á‡•§</li>';
      }
      inventoryHtml += '</ul>';

      // Profit Calculation (from ALL memos)
      let dailyProfit = 0;
      let monthlyProfit = 0;
      let grandTotalProfit = 0; 
      let grandTotalSale = 0; 
      let grandTotalDue = 0; 

      allMemos.forEach(m => {
          // Date parsing logic remains same (from previous version)
          const parts = m.date.split(', ');
          const datePart = parts[0].split('/'); 
          
          let memoDate;
          try {
             memoDate = new Date(m.date);
             if(isNaN(memoDate.getTime())) {
                const [d, mo, y] = datePart;
                memoDate = new Date(`${mo}/${d}/${y} ${parts[1]}`);
             }
          } catch(e) {
             memoDate = new Date(); 
          }
          
          const memoTotalProfit = m.totalProfit || 0;
          const memoTotalSale = m.total || 0; 
          
          grandTotalProfit += memoTotalProfit; 
          grandTotalSale += memoTotalSale; 
          grandTotalDue += m.due || 0; 
          
          if (memoDate.toDateString() === new Date().toDateString()) {
              dailyProfit += memoTotalProfit;
          }

          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();
          if (memoDate.getMonth() === currentMonth && memoDate.getFullYear() === currentYear) {
              monthlyProfit += memoTotalProfit;
          }
      });
      
      // Expense Calculations
      let totalStoreExpense = 0;
      let totalWithdrawal = 0;
      let totalFamilyExpense = 0;
      let totalPersonalExpense = 0;
      let grandTotalExpense = 0;

      expenses.forEach(e => {
          grandTotalExpense += e.amount;
          switch(e.category) {
              case 'store':
                  totalStoreExpense += e.amount;
                  break;
              case 'withdrawal':
                  totalWithdrawal += e.amount;
                  break;
              case 'family':
                  totalFamilyExpense += e.amount;
                  break;
              case 'personal':
                  totalPersonalExpense += e.amount;
                  break;
          }
      });
      
      // Conditional Profit Display in Report (Only runs if secretsVisible)
      let profitHtml = '';
      let memoProfitHtml = '';
      let expenseReportHtml = ''; 

      if (secretsVisible) {
          profitHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-4">‡¶≤‡¶æ‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶Æ‡ßã‡¶ü ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨)</h4>';
          profitHtml += `<div class="grid grid-cols-3 gap-2 text-center">
              <div class="bg-green-100 p-2 rounded-lg">
                  <p class="text-sm">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶≤‡¶æ‡¶≠ (${new Date().toLocaleDateString('bn-BD', { day: 'numeric', month: 'short' })})</p>
                  <h5 class="font-bold text-xl text-green-700">‡ß≥${fmt(dailyProfit)}</h5>
              </div>
              <div class="bg-green-100 p-2 rounded-lg col-span-2">
                  <p class="text-sm">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≤‡¶æ‡¶≠ (${new Date().toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' })})</p>
                  <h5 class="font-bold text-xl text-green-700">‡ß≥${fmt(monthlyProfit)}</h5>
              </div>
          </div>`;

          memoProfitHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-4">‡¶Æ‡ßá‡¶Æ‡ßã ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶∏‡¶ï‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßã)</h4>';
          
          if (allMemos.length > 0) {
              memoProfitHtml += '<table class="w-full border-collapse text-sm mt-2">';
              memoProfitHtml += '<thead><tr class="bg-gray-200"><th class="border p-1">‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç ‡¶ì ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th class="border p-1">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (‡ß≥)</th><th class="border p-1">‡¶≤‡¶æ‡¶≠‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</th></tr></thead>'; 
              memoProfitHtml += '<tbody>';

              allMemos.slice().reverse().forEach(m => {
                  const profit = m.totalProfit || 0;
                  const sale = m.total || 0; 
                  
                  const parts = m.date.split(', ');
                  const datePart = parts[0].split('/'); 
                  
                  let memoDate;
                  try {
                    memoDate = new Date(m.date);
                    if(isNaN(memoDate.getTime())) {
                       const [d, mo, y] = datePart;
                       memoDate = new Date(`${mo}/${d}/${y} ${parts[1]}`);
                    }
                  } catch(e) {
                     memoDate = new Date(); 
                  }
                  
                  const isToday = memoDate.toDateString() === new Date().toDateString();
                  
                  let rowClass = isToday ? 'bg-red-50 font-semibold border-2 border-red-500' : '';
                  const isHistory = memoHistory.some(h => h.id === m.id);
                  if (isHistory) rowClass = 'bg-orange-100 text-orange-800 italic border-orange-500';

                  const todayMark = isToday ? ' üî¥ (‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞)' : '';
                  const historyMark = isHistory ? ' üóìÔ∏è (‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏)' : '';


                  memoProfitHtml += `<tr class="${rowClass}"><td class="border p-1 text-center">‡¶Æ‡ßá‡¶Æ‡ßã ${m.serial} ${todayMark} ${historyMark}</td><td class="border p-1 text-right text-blue-600">‡ß≥${fmt(sale)}</td><td class="border p-1 text-right text-green-600">‡ß≥${fmt(profit)}</td></tr>`;
              });

              memoProfitHtml += '</tbody></table>';
              
              memoProfitHtml += `<div class="grid grid-cols-3 gap-2 mt-4 text-center">
                  <div class="bg-blue-100 p-2 rounded-lg border border-blue-400">
                      <p class="text-sm font-semibold">‡¶∏‡¶ï‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                      <h5 class="font-bold text-xl text-blue-800">‡ß≥${fmt(grandTotalSale)}</h5>
                  </div>
                  <div class="bg-green-100 p-2 rounded-lg border border-green-400">
                      <p class="text-sm font-semibold">‡¶∏‡¶ï‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠</p>
                      <h5 class="font-bold text-xl text-green-800">‡ß≥${fmt(grandTotalProfit)}</h5>
                  </div>
                  <div class="bg-yellow-100 p-2 rounded-lg border border-yellow-400">
                      <p class="text-sm font-semibold">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ</p>
                      <h5 class="font-bold text-xl text-yellow-800">‡ß≥${fmt(grandTotalDue)}</h5>
                  </div>
              </div>`;

          } else {
              memoProfitHtml += '<p class="text-sm text-gray-500 mt-2">‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';
          }
          
          // Expense Report HTML
          expenseReportHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-6 text-red-700">üí∏ ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ (Expense Summary)</h4>';
          expenseReportHtml += `<div class="grid grid-cols-2 gap-2 text-center mt-2">
              <div class="bg-red-100 p-2 rounded-lg border border-red-400">
                  <p class="text-sm font-semibold">‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßã‡¶ü ‡¶§‡ßã‡¶≤‡¶æ</p>
                  <h5 class="font-bold text-xl text-red-800">‡ß≥${fmt(totalWithdrawal)}</h5>
              </div>
              <div class="bg-yellow-100 p-2 rounded-lg border border-yellow-400">
                  <p class="text-sm font-semibold">‡¶Æ‡ßã‡¶ü ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</p>
                  <h5 class="font-bold text-xl text-yellow-800">‡ß≥${fmt(totalStoreExpense)}</h5>
              </div>
              <div class="bg-indigo-100 p-2 rounded-lg border border-indigo-400">
                  <p class="text-sm font-semibold">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ñ‡¶∞‡¶ö</p>
                  <h5 class="font-bold text-xl text-indigo-800">‡ß≥${fmt(totalPersonalExpense)}</h5>
              </div>
              <div class="bg-purple-100 p-2 rounded-lg border border-purple-400">
                  <p class="text-sm font-semibold">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶∞‡¶ø‡¶¨‡¶æ‡¶∞‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö</p>
                  <h5 class="font-bold text-xl text-purple-800">‡ß≥${fmt(totalFamilyExpense)}</h5>
              </div>
              <div class="bg-gray-100 p-2 rounded-lg border border-gray-400 col-span-2">
                  <p class="text-sm font-semibold">‡¶∏‡¶ï‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞ **‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö**</p>
                  <h5 class="font-bold text-xl text-gray-800">‡ß≥${fmt(grandTotalExpense)}</h5>
              </div>
          </div>`;


      }

      // 3. DUE MEMOS REPORT (Always visible)
      const dueMemos = allMemos.filter(m => (m.due || 0) > 0);
      let dueMemosHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-6 text-red-700">‚ö†Ô∏è ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ (Due Memos)</h4>';
      
      // Grand Total Due Display (Always visible)
      const grandTotalDueDisplay = `<div class="bg-red-100 p-2 rounded-lg mt-3 text-center border-2 border-red-500">
          <p class="text-sm font-semibold">‡¶∏‡¶ï‡¶≤ ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞ **‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø**</p>
          <h5 class="font-bold text-xl text-red-700">‡ß≥${fmt(grandTotalDue)}</h5>
      </div>`;
      
      dueMemosHtml += grandTotalDueDisplay;


      if (dueMemos.length > 0) {
          dueMemosHtml += '<table class="w-full border-collapse text-sm mt-4">';
          dueMemosHtml += '<thead><tr class="bg-red-100"><th class="border p-1">‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç</th><th class="border p-1">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ (‡¶®‡¶æ‡¶Æ/‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤/‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ)</th><th class="border p-1">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ (‡ß≥)</th><th class="border p-1">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</th></tr></thead>';
          dueMemosHtml += '<tbody>';

          dueMemos.slice().reverse().forEach(m => {
              const customerName = escapeHtml(m.customer.name || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á');
              const rawPhone = (m.customer.phone || '').replace(/[^0-9\+]/g, ''); 
              const customerPhone = escapeHtml(m.customer.phone || '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡ßá‡¶á');
              const customerAddr = escapeHtml(m.customer.addr || '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶®‡ßá‡¶á');
              const dueAmount = fmt(m.due);

              const message = encodeURIComponent(`‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ${customerName}, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶Æ‡ßã ‡¶®‡¶Ç ${m.serial}-‡¶è ‡ß≥${dueAmount} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá‡•§ ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ø‡¶§ ‡¶§‡¶æ‡¶°‡¶º‡¶æ‡¶§‡¶æ‡¶°‡¶º‡¶ø ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ - RKB Store`);

              const phoneLink = `tel:${rawPhone}`;
              const smsLink = `sms:${rawPhone}?body=${message}`;
              const whatsappLink = `https://wa.me/${rawPhone}?text=${message}`;
              
              const isHistory = memoHistory.some(h => h.id === m.id);
              const rowClass = isHistory ? 'bg-orange-100 text-orange-800 italic border-orange-500' : '';

              dueMemosHtml += `<tr class="${rowClass}">
                  <td class="border p-1 text-center">${m.serial} ${isHistory ? 'üóìÔ∏è' : ''}</td>
                  <td class="border p-1">
                      **${customerName}**<br>
                      <a href="${phoneLink}" class="text-blue-600 underline text-xs font-semibold">${customerPhone}</a> 
                      <span class="text-xs text-gray-500">(‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ${customerAddr})</span>
                  </td>
                  <td class="border p-1 text-right font-bold text-red-600">‡ß≥${dueAmount}</td>
                  <td class="border p-1 text-center space-y-1">
                      <a href="${phoneLink}" class="bg-green-500 text-white px-2 py-1 rounded text-xs mb-1 block">üìû ‡¶ï‡¶≤</a>
                      <a href="${smsLink}" class="bg-blue-500 text-white px-2 py-1 rounded text-xs mb-1 block">üí¨ SMS</a>
                      <a href="${whatsappLink}" target="_blank" class="bg-purple-600 text-white px-2 py-1 rounded text-xs block">üì≤ WhatsApp/Imo</a>
                  </td>
              </tr>`;
          });

          dueMemosHtml += '</tbody></table>';
          dueMemosHtml += `<p class="text-xs text-gray-500 mt-2">**‡¶¶‡ßç‡¶∞‡¶∑‡ßç‡¶ü‡¶¨‡ßç‡¶Ø:** 'WhatsApp/Imo' ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßã‡¶®‡ßá ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶•‡¶æ‡¶ï‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®: WhatsApp) ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>`;
      } else {
          dueMemosHtml += '<p class="text-sm text-green-600 mt-2">‚úÖ ‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶Æ‡ßã‡¶§‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶®‡ßá‡¶á‡•§</p>';
      }
      
      // Final render
      if (secretsVisible) {
          // New layout: Daily Expense Form/History at the top, then Inventory, then Profit/Memo, then Expense Summary, then Due Memos.
          reportContent.innerHTML = expenseLoggingAndDailyHistory + inventoryHtml + profitHtml + memoProfitHtml + expenseReportHtml + dueMemosHtml;
      } else {
          // If locked, only show non-sensitive reports (Inventory and Due Memos)
          reportContent.innerHTML = inventoryHtml + dueMemosHtml;
      }
  }
  // END Report Modal Logic
  
  // init  
  autoDeleteOldHistory(); // Run auto-deletion check on load
  updateSecretsVisibility(); // Initialize visibility based on stored state (calls renderProducts, renderHistory, updateSummary)
  
  // save on unload  
  window.addEventListener('beforeunload', ()=> { saveProducts(); saveMemos(); saveMemoHistory(); saveSerial(); saveSecretsState(); saveExpenses(); }); 
</script>  
</body>  
</html>
