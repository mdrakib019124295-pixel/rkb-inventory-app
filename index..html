<!DOCTYPE html>  
<html lang="bn">  
<head>  
  <meta charset="UTF-8" />  
  <title>ЁЯПк RKB рж╕рзНржЯрзЛрж░</title>  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <script src="https://cdn.tailwindcss.com"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>  
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:50; }  
    @media print {  
      body * { visibility: hidden; }  
      .printable, .printable * { visibility: visible; }  
      .printable { position: absolute; left: 0; top: 0; width: 100%; }  
    }  
    /* Scanner styles */
    #scanner-container {
        position: fixed;
        inset: 0;
        background: black;
        z-index: 100;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    #scanner-viewport {
        width: 100%;
        max-width: 500px;
        height: 300px;
        position: relative;
    }
    #scanner-viewport canvas, #scanner-viewport video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .drawingBuffer {
        position: absolute;
        top: 0;
        left: 0;
    }
    .barcode-feedback {
        color: white;
        margin-top: 10px;
        font-weight: bold;
    }
    .hidden-by-default { display: none; } /* Custom class for sensitive input hiding */
    .locked-field {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
    }
    /* >>>>>> ржПржЦржи рж╕ржХрзНрж░рж┐ржпрж╝ ржмрж╛ржЯржи рж▓рж╛рж▓ ржжрзЗржЦрж╛ржмрзЗ <<<<<< */
    .category-button.active {
        background-color: #dc2626; /* bg-red-600 */
        color: white;
        border-color: #dc2626; /* Add border color for better look */
    }
    .category-button:not(.active) {
        background-color: white;
        color: #4b5563; /* text-gray-700 */
        border: 1px solid #d1d5db; /* Default border */
    }
  </style>  
</head>  
<body class="bg-gray-100 min-h-screen flex justify-center py-4">  
  <div class="max-w-3xl w-full bg-white rounded-2xl shadow-lg p-5">  
    <h2 class="text-2xl font-bold mb-4 text-center">ЁЯПк RKB рж╕рзНржЯрзЛрж░</h2>  
    
    <div class="flex items-center gap-3 mb-3">
        <input id="searchInput" type="text" placeholder="ЁЯФН ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржЦрзБржБржЬрзБржи..." class="flex-grow border p-2 rounded-lg" />
        <div id="secretToggleContainer" class="flex items-center space-x-2 relative">
            <button id="secretToggleButton" class="bg-red-600 text-white p-2 rounded-lg font-semibold text-xl transition-colors" title="ржЧрзЛржкржирзАрзЯ рждржерзНржп ржжрзЗржЦрж╛ржи/рж▓рзБржХрж╛ржи">ЁЯФТ</button>
            
            <div id="inlinePasswordForm" class="absolute right-0 top-12 bg-white border p-3 rounded-lg shadow-xl hidden z-10 w-64">
                <p class="text-sm font-semibold mb-2 text-center text-red-600">ржЖржирж▓ржХ ржХрж░рж╛рж░ ржЬржирзНржп ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржжрж┐ржи</p>
                <input id="togglePasswordInput" type="password" placeholder="ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб" class="w-full border p-2 rounded-lg mb-2 text-center" />
                <button id="togglePasswordSubmit" class="w-full bg-green-600 text-white p-2 rounded-lg font-semibold">ржЖржирж▓ржХ ржХрж░рзБржи</button>
                <button id="togglePasswordCancel" class="w-full bg-gray-400 text-white p-2 rounded-lg font-semibold mt-1">ржмрж╛рждрж┐рж▓</button>
                <p class="text-xs text-gray-400 mt-2 text-center">ржЧрзЛржкржирзАрзЯрждрж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рждрзЗ ржХрзЛржирзЛ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржЗржЩрзНржЧрж┐ржд ржжрзЗржУржпрж╝рж╛ рж╣рж▓рзЛ ржирж╛ред</p>
            </div>
        </div>
    </div>

    <div class="mb-4 p-2 bg-gray-100 rounded-lg">
        <h4 class="font-bold mb-2 text-sm text-indigo-700">ржирждрзБржи ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ рждрзИрж░рж┐:</h4>
        <div class="grid grid-cols-4 gap-2">
            <input id="newCategoryNameInput" placeholder="ржирждрзБржи ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐рж░ ржирж╛ржо ржжрж┐ржи" class="border p-2 rounded-lg col-span-3" />
            <button type="button" id="addNewCategoryButton" class="bg-indigo-600 text-white p-2 rounded-lg font-semibold">тЮХ ржпрзЛржЧ ржХрж░рзБржи</button>
        </div>
    </div>
    <div id="categoryFilterContainer" class="flex flex-wrap gap-2 mb-4 p-2 bg-gray-100 rounded-lg">
        </div>
    <form id="addProductForm" class="grid grid-cols-3 gap-3 mb-4 border-b pb-4">  
      <input id="productName" placeholder="ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржирж╛ржо" class="border p-2 rounded-lg col-span-3" />  
      <select id="productCategory" class="border p-2 rounded-lg col-span-3">
          <option value="">-- ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржмрж╛ржЫрзБржи --</option>
          </select>
      
      <div class="col-span-1 hidden-by-default" data-secret="true">
        <input id="productCost" type="number" placeholder="ржХрзЗржирж╛рж░ ржжрж╛ржо (рз│)" class="border p-2 rounded-lg w-full locked-field" data-role="cost" readonly /> 
      </div>
      <input id="productPrice" type="number" placeholder="ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо (рз│)" class="border p-2 rounded-lg" />  
      <div class="col-span-1 hidden-by-default" data-secret="true">
        <input id="profitRate" type="number" placeholder="рж▓рж╛ржн (рз│)" class="border p-2 rounded-lg w-full locked-field" data-role="profit" readonly />  
      </div>
      <input id="productBarcode" placeholder="ржмрж╛рж░ржХрзЛржб (ржРржЪрзНржЫрж┐ржХ)" class="col-span-2 border p-2 rounded-lg" />
      <button type="button" id="scanNewBarcode" class="bg-gray-500 text-white p-2 rounded-lg font-semibold">рж╕рзНржХрзНржпрж╛ржи ржХрж░рзБржи</button>
      <button type="submit" class="col-span-3 bg-green-600 text-white p-2 rounded-lg font-semibold">тЮХ ржпрзЛржЧ ржХрж░рзБржи</button>  
    </form>  

    <div class="border-t pt-3 mb-4">
      <h3 class="font-bold mb-2">ЁЯУе рж╕рзНржЯржХ ржпрзЛржЧ/ржмрж┐рзЯрзЛржЧ ржХрж░рзБржи (ржоржЬрзБржж)</h3>
      <div class="grid grid-cols-4 gap-2">
          <button type="button" id="scanStockBarcode" class="bg-green-700 text-white p-2 rounded-lg col-span-4 font-semibold">ржмрж╛рж░ржХрзЛржб рж╕рзНржХрзНржпрж╛ржи ржХрж░рзЗ рж╕рзНржЯржХ ржпрзЛржЧ/ржмрж┐рзЯрзЛржЧ ржХрж░рзБржи</button>
      </div>
      <form id="updateStockForm" class="grid grid-cols-4 gap-2 mt-2">
        <select id="stockProductIndex" class="border p-2 rounded-lg col-span-2">
          <option value="">-- ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржмрж╛ржЫрзБржи --</option>
          </select>
        <input id="stockQuantity" type="number" placeholder="ржкрж░рж┐ржорж╛ржг (ржХрзЗржЬрж┐/ржкрж┐ржЫ)" class="border p-2 rounded-lg" />
        <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg font-semibold">ржЖржкржбрзЗржЯ</button>
      </form>
      <p class="text-xs text-gray-500 mt-1">ржХрзЗржЬрж┐/ржкрж┐рж╕ ржЗржиржкрзБржЯ ржжрж┐ржиред ржмрж┐рзЯрзЛржЧ ржХрж░рждрзЗ ржЛржгрж╛рждрзНржоржХ (-) рж╕ржВржЦрзНржпрж╛ ржжрж┐ржиред</p>
    </div>
    <div class="border-t pt-3 mb-4">
        <button type="button" id="scanSellBarcode" class="bg-blue-700 text-white p-2 rounded-lg w-full font-semibold">ЁЯУ╖ ржмрж╛рж░ржХрзЛржб рж╕рзНржХрзНржпрж╛ржи ржХрж░рзЗ ржмрж┐ржХрзНрж░рж┐ ржХрж░рзБржи</button>
    </div>
    <div id="productList" class="space-y-2 mb-4"></div>  

    <div class="border-t pt-3 grid grid-cols-3 gap-2 text-center mb-4">  
      <div class="bg-gray-100 p-2 rounded-lg"><p>ржорзЛржЯ ржорж╛рж▓</p><h3 id="totalQty" class="font-bold">0</h3></div>  
      <div class="bg-gray-100 p-2 rounded-lg"><p>ржорзЛржЯ ржмрж┐ржХрзНрж░рж┐</p><h3 id="totalSell" class="font-bold">рз│0</h3></div>  
      <div class="bg-gray-100 p-2 rounded-lg hidden-by-default" data-secret="true">
        <p>ржорзЛржЯ рж▓рж╛ржн</p><h3 id="totalProfit" class="font-bold text-green-600">рз│0</h3>
      </div>  
    </div>  

    <div class="border-t pt-3 mb-4">  
      <h3 class="font-bold mb-2">ЁЯСд ржХрж╛рж╕рзНржЯржорж╛рж░ рждржерзНржп</h3>  
      <div class="grid grid-cols-3 gap-2">  
        <input id="custName" placeholder="ржирж╛ржо" class="border p-2 rounded-lg" />  
        <input id="custPhone" placeholder="ржорзЛржмрж╛ржЗрж▓" class="border p-2 rounded-lg" />  
        <input id="custAddr" placeholder="ржарж┐ржХрж╛ржирж╛" class="border p-2 rounded-lg" />  
      </div>  
    </div>  

    <div class="border-t pt-3 mb-4">  
      <h3 class="font-bold mb-2">ЁЯТ░ ржмрж┐рж▓ рждржерзНржп</h3>  
      <div class="grid grid-cols-3 gap-2">  
        <input id="discountInput" type="number" placeholder="ржбрж┐рж╕ржХрж╛ржЙржирзНржЯ (рз│)" class="border p-2 rounded-lg" />  
        <input id="paidInput" type="number" placeholder="ржкрж░рж┐рж╢рзЛржзрж┐ржд (рз│)" class="border p-2 rounded-lg" />  
        <input id="dueInput" type="number" placeholder="ржмрж╛ржХрж┐ (рз│)" class="border p-2 rounded-lg bg-gray-100" readonly />  
      </div>  
    </div>  

    <div class="flex justify-between mb-4">  
      <button id="createMemo" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">ЁЯз╛ ржорзЗржорзЛ рждрзИрж░рж┐</button>  
      <button id="clearQty" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold">ЁЯФД рж░рж┐рж╕рзЗржЯ</button>  
      <div class="flex gap-2">
        <button id="openPasswordModal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hidden-by-default" data-secret="true">ЁЯФС ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи</button>
        <button id="openReport" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hidden-by-default" data-secret="true">ЁЯУИ рж░рж┐ржкрзЛрж░рзНржЯ ржУ ржЗржиржнрзЗржирзНржЯрж░рж┐</button>
      </div>
    </div>  

    <div id="memoArea" class="hidden border rounded-lg p-3 mb-4 bg-gray-50 printable"></div>  

    <div class="border-t pt-3">  
      <h3 class="font-bold mb-2">ЁЯЧВя╕П ржорзЗржорзЛ рж╣рж┐рж╕рзНржЯрзНрж░рж┐ (рж╕ржХрзНрж░рж┐ржпрж╝)</h3>  
      <div id="memoHistory" class="space-y-2"></div>  
      <button id="showPermanentHistory" class="bg-gray-600 text-white px-3 py-1 rounded-lg font-semibold mt-3 hidden-by-default" data-secret="true">ЁЯЧУя╕П ржкрзБрж░рзЛржирзЛ ржорзЗржорзЛ ржЗрждрж┐рж╣рж╛рж╕ ржжрзЗржЦрзБржи</button>
    </div>

  </div>    <div id="editModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-md p-4 shadow-lg">  
      <h3 class="text-lg font-bold mb-2">ржкржгрзНржп ржПржбрж┐ржЯ ржХрж░рзЛ</h3>  
      <div class="space-y-2">  
        <input id="editName" class="border p-2 rounded w-full" placeholder="ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржирж╛ржо" />  
        <select id="editCategory" class="border p-2 rounded w-full">
            </select>
        <input id="editCost" type="number" class="border p-2 rounded w-full locked-field" placeholder="ржХрзЗржирж╛рж░ ржжрж╛ржо (рз│)" data-secret="true" data-role="cost" readonly /> 
        <input id="editPrice" type="number" class="border p-2 rounded w-full" placeholder="ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо (рз│)" />  
        <input id="editProfit" type="number" class="border p-2 rounded w-full locked-field" placeholder="рж▓рж╛ржн (рз│)" data-secret="true" data-role="profit" readonly />  
      </div>  
      <div class="flex justify-end gap-2 mt-4">  
        <button id="cancelEdit" class="px-3 py-1 rounded bg-gray-200">ржмрж╛рждрж┐рж▓</button>  
        <button id="saveEdit" class="px-3 py-1 rounded bg-blue-600 text-white">рж╕рзЗржн</button>  
      </div>  
    </div>  
  </div>  
  
  <div id="reportModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-lg p-4 shadow-lg overflow-y-auto max-h-[90vh]">  
      <h3 class="text-xl font-bold mb-2 text-center border-b pb-2">ЁЯУИ ржЗржиржнрзЗржирзНржЯрж░рж┐ ржУ рж▓рж╛ржн рж░рж┐ржкрзЛрж░рзНржЯ</h3>  
      <div id="reportContent" class="space-y-4">
          </div>
      <div class="flex justify-end mt-4">  
        <button id="closeReport" class="px-3 py-1 rounded bg-gray-200">ржмржирзНржз ржХрж░рзБржи</button>  
      </div>  
    </div>  
  </div>
  <div id="passwordModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-sm p-5 shadow-lg">  
      <h3 class="text-xl font-bold mb-4 text-center">ЁЯФС ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи</h3>  
      <div class="space-y-3">  
        <input id="currentPassword" type="password" class="border p-3 rounded w-full" placeholder="ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржжрж┐ржи" />  
        <input id="newPassword" type="password" class="border p-3 rounded w-full" placeholder="ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржжрж┐ржи (ржХржоржкржХрзНрж╖рзЗ рзк ржЕржХрзНрж╖рж░)" />  
        <input id="confirmPassword" type="password" class="border p-3 rounded w-full" placeholder="ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи" />  
      </div>  
      <div class="flex justify-end gap-2 mt-4">  
        <button id="cancelPasswordChange" class="px-4 py-2 rounded bg-gray-400 text-white font-semibold">ржмрж╛рждрж┐рж▓</button>  
        <button id="saveNewPassword" class="px-4 py-2 rounded bg-green-600 text-white font-semibold">ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб рж╕рзЗржн ржХрж░рзБржи</button>  
      </div>  
    </div>  
  </div>
  <div id="scanner-container">
      <div id="scanner-viewport"></div>
      <p id="barcode-feedback" class="barcode-feedback">рж╕рзНржХрзНржпрж╛ржи ржХрж░рж╛рж░ ржЬржирзНржп ржмрж╛рж░ржХрзЛржбрзЗрж░ ржУржкрж░ ржХрзНржпрж╛ржорзЗрж░рж╛ ржзрж░рзБржи...</p>
      <button id="closeScanner" class="mt-4 bg-red-600 text-white p-2 rounded-lg font-semibold">ржмржирзНржз ржХрж░рзБржи</button>
  </div>
  <div id="permanentHistoryModal" class="hidden modal-backdrop">  
    <div class="bg-white rounded-lg w-full max-w-lg p-4 shadow-lg overflow-y-auto max-h-[90vh]">  
      <h3 class="text-xl font-bold mb-2 text-center border-b pb-2">ЁЯЧУя╕П ржкрзБрж░рзЛржирзЛ ржорзЗржорзЛрж░ ржЗрждрж┐рж╣рж╛рж╕ (рзз ржмржЫрж░рзЗрж░ ржоржзрзНржпрзЗ)</h3>  
      <div id="permanentMemoHistory" class="space-y-2"></div>
      <p class="text-xs text-red-500 mt-4 text-center">ржПржЗ ржорзЗржорзЛржЧрзБрж▓рж┐ рж╕рзНржмрзЯржВржХрзНрж░рж┐рзЯржнрж╛ржмрзЗ рзз ржмржЫрж░ ржкрж░ ржкрж░ ржорзБржЫрзЗ ржпрж╛ржмрзЗред</p>
      <div class="flex justify-end mt-4">  
        <button id="closePermanentHistoryModal" class="px-3 py-1 rounded bg-gray-200">ржмржирзНржз ржХрж░рзБржи</button>  
      </div>  
    </div>  
  </div>
  
  <script>  
  // DOM refs  
  const productList = document.getElementById('productList');  
  const totalQty = document.getElementById('totalQty');  
  const totalSell = document.getElementById('totalSell');  
  const totalProfit = document.getElementById('totalProfit'); 
  const searchInput = document.getElementById('searchInput');  
  
  const memoArea = document.getElementById('memoArea');  
  const memoHistoryDiv = document.getElementById('memoHistory'); // Renamed to avoid conflict
  
  const discountInput = document.getElementById('discountInput');  
  const paidInput = document.getElementById('paidInput');  
  const dueInput = document.getElementById('dueInput');  

  const reportModal = document.getElementById('reportModal');
  const reportContent = document.getElementById('reportContent');
  const stockProductIndex = document.getElementById('stockProductIndex'); 
  const productBarcodeInput = document.getElementById('productBarcode'); 
  const productCategoryInput = document.getElementById('productCategory'); 
  const categoryFilterContainer = document.getElementById('categoryFilterContainer'); 
  // NEW DOM REFS for category creation
  const newCategoryNameInput = document.getElementById('newCategoryNameInput');
  const addNewCategoryButton = document.getElementById('addNewCategoryButton');
  
  const productCostInput = document.getElementById('productCost'); 
  const profitRateInput = document.getElementById('profitRate'); 
  
  const editModal = document.getElementById('editModal');  
  const editName = document.getElementById('editName');  
  const editCategory = document.getElementById('editCategory'); 
  const editCost = document.getElementById('editCost'); 
  const editPrice = document.getElementById('editPrice');  
  const editProfit = document.getElementById('editProfit'); 
  const saveEdit = document.getElementById('saveEdit');  
  const cancelEdit = document.getElementById('cancelEdit');  

  // Barcode Scanner DOM
  const scannerContainer = document.getElementById('scanner-container');
  const barcodeFeedback = document.getElementById('barcode-feedback');
  let scannerMode = null; 

  // Password Toggle DOM
  const secretToggleButton = document.getElementById('secretToggleButton');
  const inlinePasswordForm = document.getElementById('inlinePasswordForm');
  const togglePasswordInput = document.getElementById('togglePasswordInput');
  const togglePasswordSubmit = document.getElementById('togglePasswordSubmit');
  const togglePasswordCancel = document.getElementById('togglePasswordCancel');

  // Password Change Modal DOM Refs
  const passwordModal = document.getElementById('passwordModal');
  const currentPasswordInput = document.getElementById('currentPassword');
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const saveNewPasswordButton = document.getElementById('saveNewPassword');
  const cancelPasswordChangeButton = document.getElementById('cancelPasswordChange');
  const openPasswordModalButton = document.getElementById('openPasswordModal');
  
  // NEW Permanent History Modal DOM Refs
  const showPermanentHistoryButton = document.getElementById('showPermanentHistory');
  const permanentHistoryModal = document.getElementById('permanentHistoryModal');
  const permanentMemoHistoryDiv = document.getElementById('permanentMemoHistory');

  
  // storage  
  let products = JSON.parse(localStorage.getItem('products')) || [];  
  let memos = JSON.parse(localStorage.getItem('memos')) || []; // Active memos
  let memoHistory = JSON.parse(localStorage.getItem('memoHistory')) || []; // Permanent history
  let serial = parseInt(localStorage.getItem('memoSerial')) || 1001;
  let expenses = JSON.parse(localStorage.getItem('expenses')) || []; 
  let editingIndex = null;  
  let currentMemo = null;  

  // NEW: Current selected category filter (default to 'all')
  let currentCategoryFilter = 'all';
  
  // Define default categories 
  const DEFAULT_CATEGORIES = {
      'grocery': 'ржЧрзНрж░рзЛрж╕рж╛рж░рж┐',
      'electronic': 'ржЗрж▓рзЗржХржЯрзНрж░ржирж┐ржХ',
      'other': 'ржЕржирзНржпрж╛ржирзНржп'
  };


  // SECRETS & AUTHENTICATION
  // Load password from localStorage, default to '1234'
  let SECRET_PASSWORD = localStorage.getItem('appPassword') || '1234'; 
  
  function savePassword(newPass) {
      SECRET_PASSWORD = newPass;
      localStorage.setItem('appPassword', newPass);
  }

  // Ensure initial default password is saved for persistence
  if (localStorage.getItem('appPassword') === null) {
      savePassword('1234');
  }

  // Load initial state for persistent unlock
  let secretsVisible = localStorage.getItem('secretsVisible') === 'true'; 

  function saveSecretsState() {
      localStorage.setItem('secretsVisible', secretsVisible);
  }

  function updateSecretsVisibility() {
      // 1. Toggle visibility of secret fields (using data-secret="true")
      document.querySelectorAll('[data-secret="true"]').forEach(el => {
          if (secretsVisible) {
              el.classList.remove('hidden-by-default');
          } else {
              el.classList.add('hidden-by-default');
          }
      });

      // 2. Toggle locked styles and readonly for secret inputs (cost/profit)
      document.querySelectorAll('[data-role="cost"], [data-role="profit"]').forEach(el => {
          if (secretsVisible) {
              el.classList.remove('locked-field');
              el.readOnly = false;
          } else {
              el.classList.add('locked-field');
              el.readOnly = true;
          }
      });

      // 3. Update the toggle button icon and color
      secretToggleButton.textContent = secretsVisible ? 'ЁЯФУ' : 'ЁЯФТ';
      secretToggleButton.classList.toggle('bg-red-600', !secretsVisible);
      secretToggleButton.classList.toggle('bg-green-600', secretsVisible);
      
      // 4. Re-render dependent components
      renderProducts(searchInput.value); 
      renderHistory(memos, memoHistoryDiv, 'active'); // Render active memos
      updateSummary();
      saveSecretsState();
  }

  // Event listener for the main toggle button (Lock/Unlock)
  secretToggleButton.addEventListener('click', () => {
      if (secretsVisible) {
          // Current state: UNLOCKED -> Action: LOCK
          if (confirm("ржЧрзЛржкржирзАржпрж╝ рждржерзНржп рж▓рзБржХрж╛ржирзЛрж░ ржЬржирзНржп рж▓ржХ ржХрж░ржмрзЗржи?")) {
              secretsVisible = false;
              inlinePasswordForm.classList.add('hidden');
              updateSecretsVisibility();
              alert("ЁЯФТ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ рж▓ржХ ржХрж░рж╛ рж╣рж▓рзЛред");
          }
      } else {
          // Current state: LOCKED -> Action: SHOW PASSWORD PROMPT
          inlinePasswordForm.classList.toggle('hidden');
          togglePasswordInput.value = '';
          togglePasswordInput.focus();
      }
  });

  // Event listener for inline password submission
  togglePasswordSubmit.addEventListener('click', () => {
      if (togglePasswordInput.value === SECRET_PASSWORD) { // Uses SECRET_PASSWORD variable
          secretsVisible = true;
          inlinePasswordForm.classList.add('hidden');
          updateSecretsVisibility();
          alert("ЁЯФУ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб рж╕ржарж┐ржХред ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рж╛ рж╣рж▓рзЛред");
      } else {
          alert("ржнрзБрж▓ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржбред ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред");
          togglePasswordInput.value = '';
          togglePasswordInput.focus();
      }
  });
  togglePasswordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        togglePasswordSubmit.click();
    }
  });

  // Event listener for inline password cancellation
  togglePasswordCancel.addEventListener('click', () => {
      inlinePasswordForm.classList.add('hidden');
  });
  
  // Password Change Modal Logic
  openPasswordModalButton.addEventListener('click', () => {
      if (secretsVisible) {
          passwordModal.classList.remove('hidden');
          currentPasswordInput.value = '';
          newPasswordInput.value = '';
          confirmPasswordInput.value = '';
          currentPasswordInput.focus();
      } else {
          alert("ЁЯФС ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ рж╣рж▓рзЗ рж╕рж┐рж╕рзНржЯрзЗржоржЯрж┐ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
      }
  });
  
  cancelPasswordChangeButton.addEventListener('click', () => {
      passwordModal.classList.add('hidden');
  });
  
  passwordModal.addEventListener('click', (ev) => {
      if (ev.target === passwordModal) passwordModal.classList.add('hidden');
  });

  saveNewPasswordButton.addEventListener('click', () => {
      const current = currentPasswordInput.value;
      const newPass = newPasswordInput.value;
      const confirmPass = confirmPasswordInput.value;

      if (current !== SECRET_PASSWORD) {
          alert("тЪая╕П ржмрж░рзНрждржорж╛ржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржбржЯрж┐ рж╕ржарж┐ржХ ржирзЯред");
          currentPasswordInput.focus();
          return;
      }

      if (newPass.length < 4) {
          alert("тЪая╕П ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржХржоржкржХрзНрж╖рзЗ рзк ржЕржХрзНрж╖рж░рзЗрж░ рж╣рждрзЗ рж╣ржмрзЗред");
          newPasswordInput.focus();
          return;
      }

      if (newPass !== confirmPass) {
          alert("тЪая╕П ржирждрзБржи ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржПржмржВ ржирж┐рж╢рзНржЪрж┐рждржХрж░ржг ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб ржорж┐рж▓ржЫрзЗ ржирж╛ред");
          confirmPasswordInput.focus();
          return;
      }

      // Success: Save the new password
      savePassword(newPass); // Save to variable and localStorage
      passwordModal.classList.add('hidden');
      alert("тЬЕ ржкрж╛рж╕ржУрзЯрж╛рж░рзНржб рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ! ржПржЦржи рж╕рж┐рж╕рзНржЯрзЗржоржЯрж┐ ржЖржмрж╛рж░ рж▓ржХ ржХрж░рж╛ рж╣рж▓рзЛред");
      
      // As a safety measure, automatically lock the system after changing the password
      secretsVisible = false;
      updateSecretsVisibility();
  });


  // helpers  
  function saveProducts(){ localStorage.setItem('products', JSON.stringify(products)); }  
  function saveMemos(){ localStorage.setItem('memos', JSON.stringify(memos)); } // Active Memos
  function saveMemoHistory(){ localStorage.setItem('memoHistory', JSON.stringify(memoHistory)); } // Permanent History
  function saveSerial(){ localStorage.setItem('memoSerial', serial); }  
  function saveExpenses(){ localStorage.setItem('expenses', JSON.stringify(expenses)); } 
  function fmt(n){ return Number(n||0).toFixed(2); }  
  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }  

  // NEW: Helper to format category name for display
  function formatCategoryName(key) {
      // Use the key itself if no specific mapping is found.
      if (key === 'grocery') return 'ржЧрзНрж░рзЛрж╕рж╛рж░рж┐';
      if (key === 'electronic') return 'ржЗрж▓рзЗржХржЯрзНрж░ржирж┐ржХ';
      if (key === 'other') return 'ржЕржирзНржпрж╛ржирзНржп';
      return key; 
  }

  // Helper to get all unique category keys, including defaults
  function getAllCategories() {
      const categories = new Set();
      // Add default categories
      Object.keys(DEFAULT_CATEGORIES).forEach(key => categories.add(key));

      // Add categories from products (including custom ones)
      products.forEach(p => {
          if (p.category) categories.add(p.category);
      });
      // Remove dummy category names if they exist as keys
      categories.forEach(c => {
        if (c.startsWith('__CATEGORY_')) categories.delete(c);
      })
      return Array.from(categories).sort();
  }

  // Helper to populate the Select dropdown in the Add Product and Edit Modal forms
  function populateCategoryDropdowns() {
      const allCategories = getAllCategories();
      
      // 1. Add Product Form Dropdown
      productCategoryInput.innerHTML = '<option value="">-- ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржмрж╛ржЫрзБржи --</option>';
      allCategories.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = formatCategoryName(key);
          productCategoryInput.appendChild(option);
      });

      // 2. Edit Modal Dropdown
      editCategory.innerHTML = '';
      allCategories.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = formatCategoryName(key);
          editCategory.appendChild(option);
      });
  }

  // NEW: Logic for adding a new category
  addNewCategoryButton.addEventListener('click', addNewCategory);

  function addNewCategory() {
      const newCategoryName = newCategoryNameInput.value.trim();

      if (!newCategoryName) {
          alert('тЪая╕П ржирждрзБржи ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐рж░ ржирж╛ржо ржжрж┐ржиред');
          return;
      }
      
      const lowerCaseName = newCategoryName.toLowerCase();
      
      // Check for existing categories
      const existingCategories = getAllCategories().map(c => c.toLowerCase());
      if (existingCategories.includes(lowerCaseName) || Object.values(DEFAULT_CATEGORIES).map(c => c.toLowerCase()).includes(lowerCaseName)) {
          alert(`тЪая╕П "${newCategoryName}" ржирж╛ржорзЗ ржПржХржЯрж┐ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржЗрждрж┐ржоржзрзНржпрзЗржЗ ржЖржЫрзЗ ржмрж╛ ржбрж┐ржлрж▓рзНржЯ рж╣рж┐рж╕рзЗржмрзЗ рж╕ржВрж░ржХрзНрж╖рж┐рждред`);
          return;
      }
      
      // To ensure the category is available for filtering and dropdowns, 
      // we must add at least one dummy product with that category.
      const isNewCategory = !products.some(p => p.category && p.category.toLowerCase() === lowerCaseName);

      if (isNewCategory) {
        products.push({ 
            name: `__CATEGORY_${newCategoryName}__`, // Dummy name to prevent accidental selling
            category: newCategoryName, 
            costPrice: 0, 
            price: 0, 
            profitRate: 0, 
            barcode: null, 
            kg: 0, 
            pc: 0, 
            stock: 0 
        }); 
        saveProducts();
      }

      newCategoryNameInput.value = '';
      alert(`тЬЕ ржирждрзБржи ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ "${newCategoryName}" рж╕ржлрж▓ржнрж╛ржмрзЗ рждрзИрж░рж┐ рж╣ржпрж╝рзЗржЫрзЗред`);
      
      // Re-render everything to update dropdowns and filter buttons
      renderProducts(searchInput.value); 
  }

  // Expense Logging Logic (unchanged)
  function getCategoryName(key) {
      switch(key) {
          case 'personal': return 'ржмрзНржпржХрзНрждрж┐ржЧржд ржЦрж░ржЪ';
          case 'family': return 'ржкрж╛рж░рж┐ржмрж╛рж░рж┐ржХ ржЦрж░ржЪ';
          case 'store': return 'ржжрзЛржХрж╛ржирзЗрж░ ржЦрж░ржЪ';
          case 'withdrawal': return 'ржжрзЛржХрж╛ржи ржерзЗржХрзЗ ржирж┐ржЬрзЗрж░ ржЬржирзНржп рждрзЛрж▓рж╛';
          default: return 'ржЕржирзНржпрж╛ржирзНржп ржЦрж░ржЪ';
      }
  }

  function handleExpenseSubmission(e) {
      e.preventDefault();
      const category = document.getElementById('expenseCategory').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const description = document.getElementById('expenseDescription').value.trim();

      if (!category || category === '') {
          alert('тЪая╕П ржЦрж░ржЪрзЗрж░ ржзрж░ржи ржмрж╛ржЫрзБржиред');
          return;
      }
      if (isNaN(amount) || amount <= 0) {
          alert('тЪая╕П рж╕ржарж┐ржХ ржкрж░рж┐ржорж╛ржг ржжрж┐ржиред');
          return;
      }

      const expense = {
          id: Date.now(),
          date: new Date().toISOString(), 
          category,
          amount,
          description
      };

      expenses.push(expense);
      saveExpenses();
      e.target.reset();
      
      renderReports(); 
      
      alert(`тЬЕ ${getCategoryName(category)} (${fmt(amount)} рз│) ржпрзЛржЧ рж╣рзЯрзЗржЫрзЗред`);
  }
  
  function deleteExpense(id) {
    if(confirm('ржПржЗ ржЦрж░ржЪрзЗрж░ ржПржирзНржЯрзНрж░рж┐ржЯрж┐ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ ржЪрж╛ржи?')) {
        expenses = expenses.filter(x => x.id !== id);
        saveExpenses();
        renderReports(); // Re-render the report modal
    }
  }

  function generateDailyExpenseHtml() {
      // Expense logging form HTML
      const expenseFormHtml = `
          <h4 class="font-bold mb-2 text-xl text-red-700">ЁЯТ╕ ржирждрзБржи ржЦрж░ржЪрзЗрж░ ржПржирзНржЯрзНрж░рж┐</h4>
          <form id="addExpenseFormModal" class="grid grid-cols-4 gap-2 border p-3 rounded-lg bg-red-50">
              <select id="expenseCategory" class="border p-2 rounded-lg col-span-2" required>
                  <option value="">-- ржЦрж░ржЪрзЗрж░ ржзрж░ржи ржмрж╛ржЫрзБржи --</option>
                  <option value="personal">ржмрзНржпржХрзНрждрж┐ржЧржд ржЦрж░ржЪ</option>
                  <option value="family">ржкрж╛рж░рж┐ржмрж╛рж░рж┐ржХ ржЦрж░ржЪ</option>
                  <option value="store">ржжрзЛржХрж╛ржирзЗрж░ ржЦрж░ржЪ</option>
                  <option value="withdrawal">ржжрзЛржХрж╛ржи ржерзЗржХрзЗ ржирж┐ржЬрзЗрж░ ржЬржирзНржп рждрзЛрж▓рж╛</option>
              </select>
              <input id="expenseAmount" type="number" placeholder="ржкрж░рж┐ржорж╛ржг (рз│)" class="border p-2 rounded-lg" required />
              <button type="submit" class="bg-red-600 text-white p-2 rounded-lg font-semibold">ржпрзЛржЧ ржХрж░рзБржи</button>
              <input id="expenseDescription" placeholder="ржмрж┐ржмрж░ржг (ржРржЪрзНржЫрж┐ржХ)" class="col-span-4 border p-2 rounded-lg" />
          </form>
      `;

      // Daily history logic
      const today = new Date().toISOString().substring(0, 10);
      const dailyExpenses = expenses.filter(e => e.date.startsWith(today)).reverse();
      let total = 0;
      
      let historyHtml = '<h4 class="font-bold mb-2 mt-4 text-xl">ЁЯУЕ ржЖржЬржХрзЗрж░ ржЦрж░ржЪрзЗрж░ рж╣рж┐рж╕рзНржЯрзНрж░рж┐</h4><div id="expenseHistoryInModal" class="space-y-2">';

      if (dailyExpenses.length === 0) {
          historyHtml += '<p class="text-center text-gray-500">ржЖржЬржХрзЗрж░ ржХрзЛржирзЛ ржЦрж░ржЪ ржирзЗржЗред</p>';
      } else {
          dailyExpenses.forEach(e => {
              total += e.amount;
              historyHtml += `
                  <div class="border p-2 rounded flex justify-between items-center bg-white shadow-sm">
                      <div>
                          <p class="font-semibold text-sm text-red-700">${getCategoryName(e.category)}: рз│${fmt(e.amount)}</p>
                          <p class="text-xs text-gray-500">${e.description ? escapeHtml(e.description) : 'ржХрзЛржирзЛ ржмрж┐ржмрж░ржг ржирзЗржЗ'}</p>
                      </div>
                      <button class="text-red-500 hover:text-red-700 text-lg delete-expense-in-modal" data-id="${e.id}" title="ржорзБржЫрзЗ ржлрзЗрж▓рзБржи">тЭМ</button>
                  </div>
              `;
          });
      }

      historyHtml += '</div>';
      historyHtml += `<div class="flex justify-between items-center mt-2 pt-2 border-t border-dashed">
              <span class="font-bold text-lg">ржЖржЬржХрзЗрж░ ржорзЛржЯ ржЦрж░ржЪ:</span>
              <span id="totalDailyExpenseInModal" class="font-bold text-xl text-red-700">рз│${fmt(total)}</span>
          </div>`;

      return `<div class="border p-4 rounded-lg bg-gray-50 mt-4 space-y-4">${expenseFormHtml}${historyHtml}</div>`;
  }
  // END Expense Logging Logic

  // Barcode Scanner Functions (unchanged logic)
  function startScanner(mode) {
    scannerMode = mode;
    scannerContainer.style.display = 'flex';
    barcodeFeedback.textContent = 'рж╕рзНржХрзНржпрж╛ржи ржХрж░рж╛рж░ ржЬржирзНржп ржмрж╛рж░ржХрзЛржбрзЗрж░ ржУржкрж░ ржХрзНржпрж╛ржорзЗрж░рж╛ ржзрж░рзБржи...';

    Quagga.init({
        inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector('#scanner-viewport'),
            constraints: {
                facingMode: "environment" // Use back camera
            }
        },
        decoder : {
            readers : ["ean_reader","upc_reader","code_128_reader"] // Common barcode types
        },
        locate: true
    }, function(err) {
        if (err) {
            console.error(err);
            barcodeFeedback.textContent = 'тЪая╕П ржХрзНржпрж╛ржорзЗрж░рж╛ ржЪрж╛рж▓рзБ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ: ' + err.message;
            return
        }
        Quagga.start();
        Quagga.onDetected(onBarcodeDetected);
    });
  }

  function stopScanner() {
    Quagga.stop();
    scannerContainer.style.display = 'none';
    scannerMode = null;
  }

  function onBarcodeDetected(result) {
    const code = result.codeResult.code;
    // Find product based on barcode, ignoring dummy category products
    const existingProduct = products.find(p => p.barcode === code && !p.name.startsWith('__CATEGORY_'));
    const existingProductIndex = products.findIndex(p => p.barcode === code && !p.name.startsWith('__CATEGORY_'));
    
    barcodeFeedback.textContent = `тЬЕ ржмрж╛рж░ржХрзЛржб рж╕рзНржХрзНржпрж╛ржи рж╣ржпрж╝рзЗржЫрзЗ: ${code}`;
    
    // Stop the scanner immediately
    stopScanner(); 

    if (scannerMode === 'add_product') {
        productBarcodeInput.value = code;
    } else if (scannerMode === 'add_stock') {
        if (!existingProduct) {
            alert(`тЪая╕П ржПржЗ ржмрж╛рж░ржХрзЛржб (${code}) ржПрж░ ржХрзЛржирзЛ ржкржгрзНржп ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред ржкрзНрж░ржержорзЗ 'ржпрзЛржЧ ржХрж░рзБржи' ржлрж░рзНржорзЗ ржкржгрзНржпржЯрж┐ ржпрзЛржЧ ржХрж░рзБржиред`);
            return;
        }
        // Use Product Name as the value for the dropdown
        stockProductIndex.value = existingProduct.name; 
        document.getElementById('stockQuantity').value = 1; 
        alert(`тЬЕ ${existingProduct.name} ржкржгрзНржпржЯрж┐ рж╕рзНржЯржХ ржЖржкржбрзЗржЯрзЗрж░ ржЬржирзНржп ржкрзНрж░рж╕рзНрждрзБрждред`);

    } else if (scannerMode === 'sell') {
        if (!existingProduct) {
            alert(`тЪая╕П ржПржЗ ржмрж╛рж░ржХрзЛржб (${code}) ржПрж░ ржХрзЛржирзЛ ржкржгрзНржп ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред`);
            return;
        }
        const i = existingProductIndex;
        changePc(i, 1);
        alert(`тЬЕ ${existingProduct.name} (рзз ржкрж┐ржЫ) ржорзЗржорзЛрждрзЗ ржпрзЛржЧ рж╣рзЯрзЗржЫрзЗред`);
    }
  }

  // Barcode Scanner Event Listeners
  document.getElementById('scanNewBarcode').addEventListener('click', () => startScanner('add_product'));
  document.getElementById('scanStockBarcode').addEventListener('click', () => startScanner('add_stock'));
  document.getElementById('scanSellBarcode').addEventListener('click', () => startScanner('sell'));
  document.getElementById('closeScanner').addEventListener('click', stopScanner);


  // render  
  function renderProducts(filter=''){  
    productList.innerHTML = '';  
    
    // Filter out dummy products
    const realProducts = products.filter(p => !p.name.startsWith('__CATEGORY_'));

    // Filter by Search Text
    // IMPORTANT: When creating the filtered array, attach the original index (__i) 
    // for use in button listeners (edit/delete/changeKg/changePc)
    const filteredBySearch = realProducts.map((p,i)=>({...p,
        __i:products.findIndex(pr => pr.name === p.name) // Find original index in 'products' array
    })).filter(p => 
      p.name.toLowerCase().includes(filter.toLowerCase()) || 
      (p.barcode && p.barcode.includes(filter))
    );  

    // Filter by Category
    const filtered = filteredBySearch.filter(p => {
        if (currentCategoryFilter === 'all') return true;
        // Use default categories if not explicitly set (e.g. legacy products)
        const pCategory = p.category ? p.category.toLowerCase() : 'other'; 
        return pCategory === currentCategoryFilter.toLowerCase(); // Use lower case for comparison
    });

    if(!filtered.length){ productList.innerHTML = '<p class="text-center text-gray-500">ржПржЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐рждрзЗ ржХрзЛржирзЛ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржирзЗржЗ</p>'; updateSummary(); populateStockDropdown(); populateCategoryDropdowns(); updateCategoryButtons(); return; }  
  
    filtered.forEach(p=>{  
      const i = p.__i;  // Use the original index
      const div = document.createElement('div');  
      div.className = 'border p-3 rounded-lg bg-gray-50 flex items-center justify-between';  
      
      // Conditionally render secret buttons and data based on 'secretsVisible'
      const isVisible = secretsVisible;
      const editButtonHtml = isVisible ? 
          `<button class="text-blue-600 font-semibold text-sm edit-product" data-i="${i}">тЬПя╕П</button>` : 
          `<button class="text-gray-400 font-semibold text-sm view-only" data-i="${i}" title="ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ ржЖржирж▓ржХ ржХрж░рзБржи">тЬПя╕П</button>`;
      const deleteButtonHtml = isVisible ?
          `<button class="text-red-600 font-semibold text-sm delete-product" data-i="${i}">ЁЯЧСя╕П</button>` : '';

      const secretDataHtml = isVisible ?
          `ржХрзЗржирж╛рж░ ржжрж╛ржо: рз│${fmt(p.costPrice||0)} | рж▓рж╛ржн: рз│${fmt(p.profitRate)} |` : '';

      div.innerHTML = `  
        <div class="flex items-center gap-3">
          <div>
              <div class="flex items-center gap-3 mb-1">
                  <h3 class="font-semibold">${escapeHtml(p.name)} <span class="text-xs font-normal text-indigo-500">(${formatCategoryName(p.category || 'other')})</span></h3>
                  ${editButtonHtml}
                  ${deleteButtonHtml}
              </div>
              <p class="text-xs text-gray-400">ржмрж╛рж░ржХрзЛржб: ${p.barcode || 'ржирзЗржЗ'}</p>
              <p class="text-sm text-gray-500">
                ${secretDataHtml}
                ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо: рз│${fmt(p.price)} | 
                **ржоржЬрзБржж: ${fmt(p.stock||0)}**
              </p>
          </div>
        </div>
  
        <div class="flex items-center gap-3">  
          <div class="text-center">  
            <button class="bg-red-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="kgDec" data-i="${i}">тИТ</button>  
            <div class="mx-2 font-bold text-xl" id="kg-${i}">${fmt(p.kg||0)}</div>  
            <button class="bg-green-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="kgInc" data-i="${i}">+</button>  
            <div class="text-xs text-gray-500 text-center">ржХрзЗржЬрж┐</div>  
          </div>  
          <div class="text-center">  
            <button class="bg-red-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="pcDec" data-i="${i}">тИТ</button>  
            <div class="mx-2 font-bold text-xl" id="pc-${i}">${p.pc||0}</div>  
            <button class="bg-green-500 text-white px-3 py-1 rounded text-lg font-bold" data-action="pcInc" data-i="${i}">+</button>  
            <div class="text-xs text-gray-500 text-center">ржкрж┐ржЫ</div>  
          </div>  
        </div>  
      `;  
      productList.appendChild(div);  
    });  
  
    // attach delegated listeners
    productList.querySelectorAll('[data-action="kgInc"]').forEach(b => b.addEventListener('click', e => changeKg(e.currentTarget.dataset.i, 0.25)));  
    productList.querySelectorAll('[data-action="kgDec"]').forEach(b => b.addEventListener('click', e => changeKg(e.currentTarget.dataset.i, -0.25)));  
    productList.querySelectorAll('[data-action="pcInc"]').forEach(b => b.addEventListener('click', e => changePc(e.currentTarget.dataset.i, 1)));  
    productList.querySelectorAll('[data-action="pcDec"]').forEach(b => b.addEventListener('click', e => changePc(e.currentTarget.dataset.i, -1)));  
    
    // Protected action listeners
    productList.querySelectorAll('.edit-product').forEach(b => b.addEventListener('click', e => openEditModal(parseInt(e.currentTarget.dataset.i))));  
    productList.querySelectorAll('.delete-product').forEach(b => b.addEventListener('click', e => deleteProduct(parseInt(e.currentTarget.dataset.i))));  
    // Listener for view-only edit button (prompts for unlock)
    productList.querySelectorAll('.view-only').forEach(b => b.addEventListener('click', e => {
      alert("ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржПржбрж┐ржЯ ржХрж░рж╛рж░ ржЬржирзНржп ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржкрзНрж░ржержорзЗ ржЙржкрж░рзЗ ржерж╛ржХрж╛ рж▓ржХ ржмрж╛ржЯржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
    }));
  
    updateSummary();  
    populateStockDropdown();
    populateCategoryDropdowns(); // IMPORTANT: Update dropdowns whenever products change
    updateCategoryButtons(); 
  }  

  // NEW: Category Filter Logic (Slightly improved for better visual update)
  function updateCategoryButtons() {
      // 1. Clear all buttons 
      categoryFilterContainer.innerHTML = '';
      
      // 2. Identify all unique categories (including defaults and custom ones)
      const categories = getAllCategories();
      
      // The list of categories to display in the filter, including 'all'
      const filterCategories = ['all', ...categories];

      // 3. Add all buttons to the container
      filterCategories.forEach(category => {
          const btn = document.createElement('button');
          btn.className = 'category-button px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200';
          btn.textContent = category === 'all' ? 'рж╕ржХрж▓ ржкржгрзНржп' : formatCategoryName(category);
          btn.dataset.category = category;
          
          // Apply active state if it matches the current filter
          if (category === currentCategoryFilter) {
              btn.classList.add('active');
          } else {
              // Apply default style when not active
              btn.classList.add('bg-white', 'text-gray-700', 'border');
          }
          
          categoryFilterContainer.appendChild(btn);
      });
  }

  // Delegated listener for category buttons
  categoryFilterContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.category-button');
      if (btn) {
          const newCategory = btn.dataset.category;
          if (newCategory !== currentCategoryFilter) {
              currentCategoryFilter = newCategory;
              // Reset search input when changing category
              searchInput.value = ''; 
              renderProducts(); // Re-render to show filtered products
          } else {
              // If the same category is clicked, no need to re-render, but ensure visuals are correct
              updateCategoryButtons();
          }
      }
  });


  // Stock Management Logic (MODIFIED)
  function populateStockDropdown(){
      stockProductIndex.innerHTML = '<option value="">-- ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржмрж╛ржЫрзБржи --</option>';
      products.filter(p => !p.name.startsWith('__CATEGORY_')).forEach((p, i) => { // Filter dummy products
          const option = document.createElement('option');
          // *** FIX: Use product name as the value (since indices can shift due to filtering/dummys)
          option.value = p.name; 
          // Include category in dropdown for better visibility
          option.textContent = `${p.name} (${formatCategoryName(p.category || 'other')}, ржоржЬрзБржж: ${fmt(p.stock||0)})`;
          stockProductIndex.appendChild(option);
      });
  }
  
  document.getElementById('updateStockForm').addEventListener('submit', e => {
      e.preventDefault();
      // *** FIX: Get the product name (value) from the dropdown
      const productName = stockProductIndex.value; 
      const qty = parseFloat(document.getElementById('stockQuantity').value);
  
      // *** FIX: Find the product in the main 'products' array by name
      const product = products.find(p => p.name === productName); 
      const productIndex = products.findIndex(p => p.name === productName); // For clarity in console/debug

      if (!product || isNaN(qty) || qty === 0) {
          alert('рж╕ржарж┐ржХ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржмрж╛ржЫрзБржи ржПржмржВ рж╕ржарж┐ржХ ржкрж░рж┐ржорж╛ржг ржжрж┐ржиред');
          return;
      }
      
      product.stock = (product.stock || 0) + qty;
      
      if (product.stock < 0) {
        alert(`тЪая╕П рж╕рзНржЯржХ ржЛржгрж╛рждрзНржоржХ рж╣рзЯрзЗ ржпрж╛ржЪрзНржЫрзЗред ржмрж░рзНрждржорж╛ржи рж╕рзНржЯржХ: ${fmt(product.stock)}`);
      }
  
      saveProducts();
      e.target.reset();
      renderProducts(searchInput.value); // Re-render to show updated stock
      alert(`тЬЕ ${product.name} ржПрж░ ржоржЬрзБржж ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗред ржмрж░рзНрждржорж╛ржи ржоржЬрзБржж: ${fmt(product.stock)}`);
  });
  // END Stock Management Logic


  // edit modal functions  
  function openEditModal(index){  
    // Check if secrets are visible/unlocked for editing sensitive fields
    const isVisible = secretsVisible;
    if (!isVisible) {
        alert("ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржПржбрж┐ржЯ ржХрж░рж╛рж░ ржЬржирзНржп ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржкрзНрж░ржержорзЗ ржЙржкрж░рзЗ ржерж╛ржХрж╛ рж▓ржХ ржмрж╛ржЯржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
        return; 
    } 
    
    editingIndex = index;  
    const p = products[index];  
    
    // Ensure category dropdown is populated before setting value
    populateCategoryDropdowns(); 

    editName.value = p.name || '';  
    editCategory.value = p.category || 'other'; 
    editCost.value = p.costPrice !== undefined ? p.costPrice : ''; 
    editProfit.value = p.profitRate !== undefined ? p.profitRate : '';  
    editPrice.value = p.price !== undefined ? p.price : '';  
    editModal.classList.remove('hidden');  
    editName.focus();  
  }  
  function closeEditModal(){ editingIndex = null; editModal.classList.add('hidden'); }  
  
  saveEdit.addEventListener('click', ()=>{  
    if(editingIndex === null) return closeEditModal();  
    
    const name = editName.value.trim();  
    const category = editCategory.value.trim() || 'other'; 
    const price = parseFloat(editPrice.value); 
    
    if(!name || isNaN(price)){ alert('ржирж╛ржо, ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржУ рж╕ржарж┐ржХ ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо ржжрж┐ржи'); return; }
        
    products[editingIndex].name = name;
    products[editingIndex].category = category; 
    products[editingIndex].price = price;

    if (secretsVisible) {
      // If unlocked, save all fields
      const cost = parseFloat(editCost.value); 
      const profit = parseFloat(editProfit.value);  
      
      if(isNaN(cost)){ alert('рж╕ржарж┐ржХ ржХрзЗржирж╛рж░ ржжрж╛ржо ржжрж┐ржи'); return; } 
      if(isNaN(profit)){ alert('рж╕ржарж┐ржХ рж▓рж╛ржнрзЗрж░ рж╕ржВржЦрзНржпрж╛ ржжрж┐ржи'); return; }  
      
      products[editingIndex].costPrice = cost; 
      products[editingIndex].profitRate = profit;  
      alert('тЬЕ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ'); 
    } else {
        alert('тЬЕ ржкрзНрж░рзЛржбрж╛ржХрзНржЯрзЗрж░ ржирж╛ржо, ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржУ ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ');
    }

    saveProducts();
    renderProducts(searchInput.value);  
    updateSummary();  
    closeEditModal();  
  });  
  
  cancelEdit.addEventListener('click', ()=> closeEditModal());  
  editModal.addEventListener('click', (ev)=>{ if(ev.target === editModal) closeEditModal(); });  
  
  // CRUD product helpers  
  function deleteProduct(i){  
    if (!secretsVisible) {
        alert("ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржорзБржЫрзЗ ржлрзЗрж▓рж╛рж░ ржЬржирзНржп ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржкрзНрж░ржержорзЗ ржЙржкрж░рзЗ ржерж╛ржХрж╛ рж▓ржХ ржмрж╛ржЯржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
        return;
    }
    // Check if it's a dummy category product
    if (products[i].name.startsWith('__CATEGORY_')) {
        if(!confirm(`ржПржЗ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐-ржкрзНрж░рждрж┐ржирж┐ржзрж┐ржЯрж┐ ржорзБржЫрзЗ ржлрзЗрж▓рж▓рзЗ ржирждрзБржи рждрзИрж░рж┐ ржХрж░рж╛ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ (${products[i].category}) ржЯрж┐ ржлрж┐рж▓рзНржЯрж╛рж░ ржмрж╛ржЯржи ржерзЗржХрзЗ рж▓рзБржХрж┐ржпрж╝рзЗ ржпрзЗрждрзЗ ржкрж╛рж░рзЗред ржЖржкржирж┐ ржХрж┐ ржирж┐рж╢рзНржЪрж┐ржд?`)) return;
    } else if(!confirm('ржПржЗ ржкрзНрж░рзЛржбрж╛ржХрзНржЯржЯрж┐ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ ржЪрж╛ржи?')) {
        return;
    }
    
    products.splice(i,1);  
    saveProducts();  
    renderProducts(searchInput.value);  
    updateSummary();  
  }  
  
  function changeKg(i, delta){  
    i = parseInt(i);  
    
    const newKg = (products[i].kg||0) + delta;
    
    // Logic to check stock against new quantity 
    if (delta > 0) {
        const currentPc = products[i].pc || 0; 
        const currentStock = products[i].stock || 0;
        const totalSold = newKg + currentPc;
        if (currentStock < totalSold) {
            alert(`тЪая╕П ${products[i].name} ржПрж░ ржкрж░рзНржпрж╛ржкрзНржд рж╕рзНржЯржХ ржирзЗржЗред ржкрзНрж░ржпрж╝рзЛржЬржи: ${fmt(totalSold)}, ржоржЬрзБржж: ${fmt(currentStock)}`);
            return; 
        }
    }
    
    products[i].kg = newKg;  
    if(products[i].kg < 0) products[i].kg = 0;  
    saveProducts();  
    document.getElementById(`kg-${i}`).textContent = fmt(products[i].kg);  
    updateSummary(); updateDueAmount();  
  }  
  function changePc(i, delta){  
    i = parseInt(i);  
    
    const newPc = (products[i].pc||0) + delta;
    
    // Logic to check stock against new quantity (pc and kg count towards total stock for simplicity)
    if (delta > 0) {
        const currentKg = products[i].kg || 0; 
        const currentStock = products[i].stock || 0;
        const totalSold = newPc + currentKg;
        if (currentStock < totalSold) {
            alert(`тЪая╕П ${products[i].name} ржПрж░ ржкрж░рзНржпрж╛ржкрзНржд рж╕рзНржЯржХ ржирзЗржЗред ржкрзНрж░ржпрж╝рзЛржЬржи: ${fmt(totalSold)}, ржоржЬрзБржж: ${fmt(currentStock)}`);
            return; 
        }
    }

    products[i].pc = newPc;
    if(products[i].pc < 0) products[i].pc = 0;
    
    saveProducts();  
    document.getElementById(`pc-${i}`).textContent = products[i].pc;  
    updateSummary(); updateDueAmount();  
  }  
  
  // summary & bill calculations  
  function updateSummary(){  
    // Filter out dummy products
    const realProducts = products.filter(p => !p.name.startsWith('__CATEGORY_'));

    const totalQtyValue = realProducts.reduce((s,p)=> s + (p.kg||0) + (p.pc||0), 0);  
    const sell = realProducts.reduce((s,p)=> s + ((p.kg||0) * (p.price||0)) + ((p.pc||0) * (p.price||0)), 0);  
    
    // Profit calculation now considers ALL memos (active + history)
    const allMemos = [...memos, ...memoHistory];
    const totalProfitValue = allMemos.reduce((s, m) => s + (m.totalProfit || 0), 0);
    
    totalQty.textContent = fmt(totalQtyValue);  
    totalSell.textContent = 'рз│' + fmt(sell);  
    
    // Only update totalProfit if secrets are visible
    if (secretsVisible) {
        totalProfit.textContent = 'рз│' + fmt(totalProfitValue);
        totalProfit.parentElement.classList.remove('hidden-by-default');
    } else {
        totalProfit.textContent = 'рз│???.??';
        totalProfit.parentElement.classList.add('hidden-by-default');
    }
  }  
  
  function updateDueAmount(){  
    const items = products.filter(p=> (p.kg||0) > 0 || (p.pc||0) > 0);  
    const totalAmount = items.reduce((s,p)=> s + ((p.kg||0) * (p.price||0)) + ((p.pc||0) * (p.price||0)), 0);  
    const discount = parseFloat(discountInput.value) || 0;  
    const paid = parseFloat(paidInput.value) || 0;  
    const grand = totalAmount - discount;  
    const due = grand - paid;  
    dueInput.value = due >= 0 ? fmt(due) : fmt(0);  
  }  
  discountInput.addEventListener('input', updateDueAmount);  
  paidInput.addEventListener('input', updateDueAmount);  
  
  // add product  
  document.getElementById('addProductForm').addEventListener('submit', e=>{  
    e.preventDefault();  
    const name = document.getElementById('productName').value.trim();  
    const price = parseFloat(document.getElementById('productPrice').value);  
    const category = productCategoryInput.value.trim();
    
    if(!category){ alert('тЪая╕П ржкрзНрж░рзЛржбрж╛ржХрзНржЯрзЗрж░ ржЬржирзНржп рж╕ржарж┐ржХ ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐ ржмрж╛ржЫрзБржиред'); return; }
    
    let costPrice = 0;
    let profit = 0;
    
    if (secretsVisible) {
      costPrice = parseFloat(productCostInput.value) || 0; 
      profit = parseFloat(profitRateInput.value) || 0;  
      if (isNaN(costPrice)){ alert('рж╕ржарж┐ржХ ржХрзЗржирж╛рж░ ржжрж╛ржо ржжрж┐ржи'); return; }
    } else {
      // If not authenticated, ensure selling price is valid
      if(isNaN(price) || !name){ alert('ржирж╛ржо ржУ рж╕ржарж┐ржХ ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо ржжрж┐ржи'); return; }
    }
    
    const barcode = productBarcodeInput.value.trim() || null;
    
    if(!name || isNaN(price)){ alert('ржирж╛ржо ржУ рж╕ржарж┐ржХ ржжрж╛ржо ржжрж┐ржи'); return; }  
    
    // Check for duplicate barcode in real products
    if (barcode && products.some(p => p.barcode === barcode && !p.name.startsWith('__CATEGORY_'))) {
        alert('тЪая╕П ржПржЗ ржмрж╛рж░ржХрзЛржбржЯрж┐ ржЕржирзНржп ржПржХржЯрж┐ ржкржгрзНржпрзЗрж░ рж╕рж╛ржерзЗ ржЗрждрж┐ржоржзрзНржпрзЗржЗ ржпрзБржХрзНржд ржЖржЫрзЗред');
        return;
    }
    
    // Check for duplicate name in real products
    if (products.some(p => p.name.toLowerCase() === name.toLowerCase() && !p.name.startsWith('__CATEGORY_'))) {
        alert('тЪая╕П ржПржЗ ржирж╛ржорзЗрж░ ржПржХржЯрж┐ ржкржгрзНржп ржЗрждрж┐ржоржзрзНржпрзЗржЗ ржЖржЫрзЗред');
        return;
    }

    products.push({ name, category, costPrice: costPrice, price, profitRate: profit, barcode, kg: 0, pc: 0, stock: 0 }); 
    saveProducts();  
    e.target.reset();  
    renderProducts();  
  });  
  
  // create memo (MODIFIED: Saves to memos, then copies to history upon delete/permanent save)
  document.getElementById('createMemo').addEventListener('click', ()=>{  
    const items = products.filter(p=> (p.kg||0) > 0 || (p.pc||0) > 0);  
    if(items.length === 0){ alert('ржкрзНрж░ржержорзЗ ржкржгрзНржп ржпрзЛржЧ ржХрж░рзБржи'); return; }  
  
    const totalAmount = items.reduce((s,p)=> s + ((p.kg||0) * p.price) + ((p.pc||0) * p.price), 0);  
    const totalProfit = items.reduce((s,p)=> s + (((p.kg||0) + (p.pc||0)) * (p.profitRate||0)), 0); 
    const discount = parseFloat(discountInput.value) || 0;  
    const paid = parseFloat(paidInput.value) || 0;  
    const due = totalAmount - discount - paid;  

    let deductionSuccessful = true;
    const itemsToDeduct = [];
    for(const item of items) {
        // Find the index of the product by name.
        const index = products.findIndex(p => p.name === item.name); 
        // Stock deduction is based on the total quantity sold (kg + pc)
        const soldQty = (item.kg || 0) + (item.pc || 0);

        if (index === -1) {
             console.warn(`Product "${item.name}" not found during memo creation. Skipping stock deduction.`);
             continue;
        }

        if ((products[index].stock || 0) < soldQty) {
            alert(`тЪая╕П ржорзЗржорзЛ рждрзИрж░рж┐ ржХрж░рж╛ рж╕ржорзНржнржм ржирзЯред "${item.name}" ржПрж░ ржкрж░рзНржпрж╛ржкрзНржд рж╕рзНржЯржХ ржирзЗржЗред ржкрзНрж░ржпрж╝рзЛржЬржи: ${fmt(soldQty)}, ржоржЬрзБржж: ${fmt(products[index].stock || 0)}`);
            deductionSuccessful = false;
            break;
        }
        itemsToDeduct.push({ index, soldQty });
    }
    
    if(!deductionSuccessful) return; 
  
    const memo = {  
      id: Date.now(),  
      serial,  
      date: new Date().toLocaleString(),  
      customer: {  
        name: document.getElementById('custName').value || '',  
        phone: document.getElementById('custPhone').value || '',  
        addr: document.getElementById('custAddr').value || ''  
      },  
      items: items.map(p => ({ 
        name: p.name, 
        category: p.category || 'other', 
        kg: p.kg||0, 
        pc: p.pc||0, 
        price: p.price||0, 
        profitRate: p.profitRate || 0, 
        profit: ((p.kg||0) + (p.pc||0)) * (p.profitRate||0) 
      })),  
      total: totalAmount,  
      totalProfit: totalProfit, 
      discount,  
      paid,  
      due,
    };  
  
    memos.push(memo); saveMemos(); serial++; saveSerial();  
  
    // Deduct stock after successful memo creation
    itemsToDeduct.forEach(deduction => {
        products[deduction.index].stock -= deduction.soldQty;
    });

    // Reset selling quantity after memo creation
    products.forEach(p => { p.kg = 0; p.pc = 0; });  
    saveProducts(); 

    document.getElementById('custName').value = '';  
    document.getElementById('custPhone').value = '';  
    document.getElementById('custAddr').value = '';  
    discountInput.value = ''; paidInput.value = ''; dueInput.value = '';  
  
    renderProducts();  
    renderHistory(memos, memoHistoryDiv, 'active');  
    showMemo(memo);  
    alert('ЁЯз╛ ржорзЗржорзЛ рждрзИрж░рж┐ рж╣рзЯрзЗржЫрзЗ ржУ ржЗржиржнрзЗржирзНржЯрж░рж┐ ржЖржкржбрзЗржЯ рж╣рзЯрзЗржЫрзЗ');  
  });  
  
  // print / pdf functions
  function printMemo(id, isHistory = false){  
    const memoArray = isHistory ? memoHistory : memos;
    const m = memoArray.find(x=> x.id === id);  
    if(!m) return alert('ржорзЗржорзЛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐');  
    const w = window.open('', '', 'width=800,height=600');  
    w.document.write('<html><head><title>ржорзЗржорзЛ</title></head><body>');  
    w.document.write(generateMemoInnerHTML(m));  
    w.document.write('</body></html>');  
    w.document.close(); w.focus();  
    setTimeout(()=> { w.print(); w.close(); }, 300);  
  }  
  
  async function pdfMemo(id, isHistory = false){  
    const memoArray = isHistory ? memoHistory : memos;
    const m = memoArray.find(x=> x.id === id);  
    if(!m) return alert('ржорзЗржорзЛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐');  
    const container = document.createElement('div');  
    container.style.width = '800px'; container.style.padding='20px'; container.style.background='white';  
    container.innerHTML = generateMemoInnerHTML(m);  
    document.body.appendChild(container);  
    try{  
      const canvas = await html2canvas(container, { scale: 2 });  
      const img = canvas.toDataURL('image/png');  
      const { jsPDF } = window.jspdf;  
      const pdf = new jsPDF({ unit:'pt', format:'a4' });  
      const pdfWidth = pdf.internal.pageSize.getWidth();  
      const imgProps = pdf.getImageProperties(img);  
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;  
      pdf.addImage(img, 'PNG', 0, 0, pdfWidth, pdfHeight);  
      pdf.save(`memo_${m.serial}.pdf`);  
    }catch(err){ console.error(err); alert('PDF рждрзИрж░рж┐рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ'); }  
    finally{ document.body.removeChild(container); }  
  }  
  
  function generateMemoInnerHTML(m){  
    return `<div style="text-align:center"><h2>ЁЯПк RKB рж╕рзНржЯрзЛрж░</h2><p style="font-size:12px">ржарж┐ржХрж╛ржирж╛: рждрзЛржорж╛рж░ ржарж┐ржХрж╛ржирж╛ | ржлрзЛржи: рзжрззрзнрзжрзж-рзжрзжрзжрзжрзж</p><hr/></div>  
      <div style="font-size:12px;margin-top:6px;"><div><strong>ржорзЗржорзЛ ржиржВ:</strong> ${m.serial}</div><div><strong>рждрж╛рж░рж┐ржЦ:</strong> ${m.date}</div>  
      ${m.customer.name?`<div><strong>ржирж╛ржо:</strong> ${escapeHtml(m.customer.name)}</div>`:''}  
      ${m.customer.phone?`<div><strong>ржорзЛржмрж╛ржЗрж▓:</strong> ${escapeHtml(m.customer.phone)}</div>`:''}  
      ${m.customer.addr?`<div><strong>ржарж┐ржХрж╛ржирж╛:</strong> ${escapeHtml(m.customer.addr)}</div>`:''}</div>  
      <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:12px;">  
        <tr style="background:#f3f3f3"><th style="border:1px solid #ddd;padding:6px">#</th><th style="border:1px solid #ddd;padding:6px">ржкржгрзНржп (ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐)</th><th style="border:1px solid #ddd;padding:6px">ржХрзЗржЬрж┐</th><th style="border:1px solid #ddd;padding:6px">ржкрж┐ржЫ</th><th style="border:1px solid #ddd;padding:6px">ржжрж╛ржо</th><th style="border:1px solid #ddd;padding:6px">ржорзЛржЯ</th></tr>  
        ${m.items.map((it,idx)=>`<tr><td style="border:1px solid #ddd;padding:6px">${idx+1}</td><td style="border:1px solid #ddd;padding:6px">${escapeHtml(it.name)} (${formatCategoryName(it.category || 'other')})</td><td style="border:1px solid #ddd;padding:6px">${fmt(it.kg)}</td><td style="border:1px solid #ddd;padding:6px">${it.pc}</td><td style="border:1px solid #ddd;padding:6px">рз│${fmt(it.price)}</td><td style="border:1px solid #ddd;padding:6px">рз│${fmt((it.kg*it.price + it.pc*it.price))}</td></tr>`).join('')}  
      </table>  
      <div style="text-align:right;margin-top:8px;font-weight:bold;">ржорзЛржЯ: рз│${fmt(m.total)}</div>  
      <div style="text-align:right;margin-top:2px;">ржбрж┐рж╕ржХрж╛ржЙржирзНржЯ: рз│${fmt(m.discount)} | ржкрж░рж┐рж╢рзЛржзрж┐ржд: рз│${fmt(m.paid)} | ржмрж╛ржХрж┐: рз│${fmt(m.due)}</div>  
      <p style="text-align:center;font-size:11px;margin-top:8px;">ржзржирзНржпржмрж╛ржж тАФ ржЖржмрж╛рж░ ржЖрж╕ржмрзЗржи ЁЯЩП</p>`;  
  }  
  
  // *************************************************************
  // ржорзЗржорзЛ ржмрж╛рждрж┐рж▓ ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи (Cancel Memo - Restores Stock & Financials - FROM ACTIVE MEMOS)
  // *************************************************************
  function cancelMemo(id){  
      // 1. рж╕рзБрж░ржХрзНрж╖рж╛ ржкрж░рзАржХрзНрж╖рж╛
      if(!secretsVisible) {
          alert("тЪая╕П ржорзЗржорзЛ ржмрж╛рждрж┐рж▓ ржХрж░рж╛рж░ ржЬржирзНржп ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржкрзНрж░ржержорзЗ ржЙржкрж░рзЗ ржерж╛ржХрж╛ рж▓ржХ ржмрж╛ржЯржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
          return;
      }
      
      // 2. ржирж┐рж╢рзНржЪрж┐рждржХрж░ржг ржмрж╛рж░рзНрждрж╛
      if(!confirm('ЁЯЪи ржЖржкржирж┐ ржХрж┐ ржПржЗ ржорзЗржорзЛржЯрж┐ ржмрж╛рждрж┐рж▓ (Cancel) ржХрж░рждрзЗ ржирж┐рж╢рзНржЪрж┐ржд? ржмрж╛рждрж┐рж▓ ржХрж░рж▓рзЗ ржкржгрзНржпрзЗрж░ рж╕рзНржЯржХ ржПржмржВ рж▓рж╛ржн-ржХрзНрж╖рждрж┐рж░ рж╣рж┐рж╕рж╛ржм ржкрзБржирж░рзБржжрзНржзрж╛рж░ ржХрж░рж╛ рж╣ржмрзЗред ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рждрзЗ "OK" ржЪрж╛ржкрзБржиред')) return;  
      
      // 3. ржорзЗржорзЛ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛
      const memoIndex = memos.findIndex(m => m.id === id);
      if(memoIndex === -1) {
          alert("тЪая╕П ржорзЗржорзЛржЯрж┐ ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред");
          return;
      }
      const memoToDelete = memos[memoIndex];

      // 4. рж╕рзНржЯржХ ржкрзБржирж░рзБржжрзНржзрж╛рж░ (Restore Stock)
      memoToDelete.items.forEach(item => {
          // *** FIX: Find product by name
          const product = products.find(p => p.name === item.name); 
          if (product) {
              const soldQty = (item.kg || 0) + (item.pc || 0);
              product.stock = (product.stock || 0) + soldQty; 
          } else {
              console.warn(`Product "${item.name}" not found for stock restoration. Stock remains unchanged for this item.`);
          }
      });

      // 5. ржорзЗржорзЛ ржЕрзНржпрж╛рж░рзЗ ржерзЗржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ (ржмрж╛рждрж┐рж▓ ржорж╛ржирзЗржУ ржорзБржЫрзЗ ржлрзЗрж▓рж╛)
      memos.splice(memoIndex, 1);
      
      // 6. ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рзЛ рж╕рзЗржн ржХрж░рж╛ ржПржмржВ рж░рзЗржирзНржбрж╛рж░ ржЖржкржбрзЗржЯ ржХрж░рж╛
      saveProducts();    
      saveMemos();    

      renderHistory(memos, memoHistoryDiv, 'active');           
      renderProducts(searchInput.value); 
      updateSummary();           
      
      if(currentMemo && currentMemo.id === id){ 
          memoArea.classList.add('hidden'); 
          currentMemo = null; 
      }  
      
      alert(`тЬЕ ржорзЗржорзЛ ${memoToDelete.serial} рж╕ржлрж▓ржнрж╛ржмрзЗ ржмрж╛рждрж┐рж▓ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред рж╕рзНржЯржХ ржПржмржВ рж▓рж╛ржн-ржХрзНрж╖рждрж┐рж░ рж╣рж┐рж╕рж╛ржм ржкрзБржирж░рзБржжрзНржзрж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред`);
  }
  
  // *************************************************************
  // рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ рж╕рзЗржн ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи (Delete to Permanent History - NO STOCK RESTORE)
  // *************************************************************
  function deleteToPermanentHistory(id) {
       // 1. рж╕рзБрж░ржХрзНрж╖рж╛ ржкрж░рзАржХрзНрж╖рж╛
       if(!secretsVisible) {
          alert("тЪая╕П ржорзЗржорзЛ рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ рж╕рзЗржн ржХрж░рж╛рж░ ржЬржирзНржп ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржкрзНрж░ржержорзЗ ржЙржкрж░рзЗ ржерж╛ржХрж╛ рж▓ржХ ржмрж╛ржЯржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
          return;
      }
      
      // 2. ржирж┐рж╢рзНржЪрж┐рждржХрж░ржг ржмрж╛рж░рзНрждрж╛ (Permanent Save)
      if(!confirm('ЁЯТ╛ ржЖржкржирж┐ ржХрж┐ ржПржЗ ржорзЗржорзЛржЯрж┐ **ржЗрждрж┐рж╣рж╛рж╕рзЗ рж╕ржВрж░ржХрзНрж╖ржг** ржХрж░рзЗ рж╕ржХрзНрж░рж┐ржпрж╝ рждрж╛рж▓рж┐ржХрж╛ ржерзЗржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ ржЪрж╛ржи? ржоржирзЗ рж░рж╛ржЦржмрзЗржи, рж╕рзНржЯржХ ржкрзБржирж░рзБржжрзНржзрж╛рж░ рж╣ржмрзЗ ржирж╛, ржХрж┐ржирзНрждрзБ рж▓рж╛ржн рж░рж┐ржкрзЛрж░рзНржЯрзЗ рж╣рж┐рж╕рж╛ржм ржерж╛ржХржмрзЗред')) return;  

      // 3. ржорзЗржорзЛ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж╛ ржПржмржВ ржХржкрж┐ рждрзИрж░рж┐
      const memoIndex = memos.findIndex(m => m.id === id);
      if(memoIndex === -1) {
          alert("тЪая╕П ржорзЗржорзЛржЯрж┐ ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред");
          return;
      }
      
      const memoToSave = memos[memoIndex];
      // Note: We move the memo, the profit calculation remains because the profit is calculated from ALL memos (active + history)

      // 4. ржорзЗржорзЛ рж╣рж┐рж╕рзНржЯрзНрж░рж┐рждрзЗ ржпрзЛржЧ ржХрж░рж╛ ржПржмржВ рж╕ржХрзНрж░рж┐рзЯ рждрж╛рж▓рж┐ржХрж╛ ржерзЗржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛
      memoHistory.push(memoToSave);
      memos.splice(memoIndex, 1);
      
      // 5. ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рзЛ рж╕рзЗржн ржХрж░рж╛ ржПржмржВ рж░рзЗржирзНржбрж╛рж░ ржЖржкржбрзЗржЯ ржХрж░рж╛
      saveMemos();    
      saveMemoHistory();
      
      renderHistory(memos, memoHistoryDiv, 'active'); // Re-render active memos
      
      if(currentMemo && currentMemo.id === id){ 
          memoArea.classList.add('hidden'); 
          currentMemo = null; 
      }  
      
      alert(`тЬЕ ржорзЗржорзЛ ${memoToSave.serial} рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрзБрж░рзЛржирзЛ ржЗрждрж┐рж╣рж╛рж╕рзЗ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред`);
  }

  // *************************************************************
  // ржЗрждрж┐рж╣рж╛рж╕ ржерзЗржХрзЗ рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ (Permanent Delete from History)
  // *************************************************************
  function deleteMemoPermanentlyFromHistory(id){  
      if(!confirm('ЁЯЪи ржЖржкржирж┐ ржХрж┐ ржПржЗ ржорзЗржорзЛржЯрж┐ **ржЪрж┐рж░рждрж░рзЗ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ** ржЪрж╛ржи? ржПрж░ рж▓рж╛ржн рж░рж┐ржкрзЛрж░рзНржЯ ржерзЗржХрзЗржУ ржорзБржЫрзЗ ржпрж╛ржмрзЗред ржПржЗ ржкржжржХрзНрж╖рзЗржкржЯрж┐ ржЖрж░ ржлрж┐рж░рж┐ржпрж╝рзЗ ржЖржирж╛ ржпрж╛ржмрзЗ ржирж╛ред')) return;  
      
      const memoIndex = memoHistory.findIndex(m => m.id === id);
      if(memoIndex === -1) {
          alert("тЪая╕П ржорзЗржорзЛржЯрж┐ ржЦрзБржБржЬрзЗ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ред");
          return;
      }
      const memoToDelete = memoHistory[memoIndex];

      memoHistory.splice(memoIndex, 1);
      
      saveMemoHistory();    
      updateSummary(); // Re-calculate total profit
      renderHistory(memoHistory, permanentMemoHistoryDiv, 'history'); // Re-render the history modal
      
      if(currentMemo && currentMemo.id === id){ 
          memoArea.classList.add('hidden'); 
          currentMemo = null; 
      }  
      
      alert(`тЬЕ ржорзЗржорзЛ ${memoToDelete.serial} рж╕рзНржерж╛ржпрж╝рзАржнрж╛ржмрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣ржпрж╝рзЗржЫрзЗред`);
  }

  // show memo (UPDATED to include Cancel and Permanent Save/Delete buttons)
  function showMemo(m, isHistory = false){  
      currentMemo = m;  
      memoArea.classList.remove('hidden');  
      
      // ржмрж╛рждрж┐рж▓ ржмрж╛ржЯржи (рж╕рзНржЯржХ ржкрзБржирж░рзБржжрзНржзрж╛рж░ рж╕рж╣ - рж╢рзБржзрзБ Active Memos-ржПрж░ ржЬржирзНржп)
      const cancelButtonHtml = !isHistory && secretsVisible ? 
          `<button class="bg-red-500 text-white px-3 py-1 rounded" onclick="cancelMemo(${m.id})">тЖйя╕П ржмрж╛рждрж┐рж▓ (рж╕рзНржЯржХ ржкрзБржирж░рзБржжрзНржзрж╛рж░)</button>` : 
          !isHistory && `<button class="bg-gray-400 text-white px-3 py-1 rounded" title="ржмрж╛рждрж┐рж▓ ржХрж░рждрзЗ ржЖржирж▓ржХ ржХрж░рзБржи">ЁЯФТ ржмрж╛рждрж┐рж▓</button>`;
          
      // рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ рж╕рзЗржн ржмрж╛ржЯржи (ржЗрждрж┐рж╣рж╛рж╕рзЗ ржпрзБржХрзНржд рж╣ржмрзЗ - рж╢рзБржзрзБ Active Memos-ржПрж░ ржЬржирзНржп)
      const deleteButtonHtml = !isHistory && secretsVisible ? 
          `<button class="bg-gray-700 text-white px-3 py-1 rounded" onclick="deleteToPermanentHistory(${m.id})">ЁЯТ╛ рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ рж╕рзЗржн</button>` : 
          !isHistory && `<button class="bg-gray-400 text-white px-3 py-1 rounded" title="рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ рж╕рзЗржн ржХрж░рждрзЗ ржЖржирж▓ржХ ржХрж░рзБржи">ЁЯФТ рж╕рзЗржн</button>`;
          
      // ржЗрждрж┐рж╣рж╛рж╕ ржерзЗржХрзЗ ржбрж┐рж▓рж┐ржЯ ржмрж╛ржЯржи (рж╢рзБржзрзБ Permanent History-ржПрж░ ржЬржирзНржп)
      const permanentDeleteButtonHtml = isHistory && secretsVisible ?
          `<button class="bg-red-800 text-white px-3 py-1 rounded" onclick="deleteMemoPermanentlyFromHistory(${m.id})">ЁЯЧСя╕П рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ ржбрж┐рж▓рж┐ржЯ (рж░рж┐ржкрзЛрж░рзНржЯ рж╕рж╣)</button>` : '';

      memoArea.innerHTML = `  
        <div class="text-center mb-2">  
          <h3 class="font-bold text-lg">ЁЯПк RKB рж╕рзНржЯрзЛрж░</h3>  
        </div>  
        <div class="text-sm mb-2">  
          ржорзЗржорзЛ: ${m.serial} | рждрж╛рж░рж┐ржЦ: ${m.date}<br>  
          ${m.customer.name?`ржирж╛ржо: ${escapeHtml(m.customer.name)}<br>`:''}  
          ${m.customer.phone?`ржорзЛржмрж╛ржЗрж▓: ${escapeHtml(m.customer.phone)}<br>`:''}  
          ${m.customer.addr?`ржарж┐ржХрж╛ржирж╛: ${escapeHtml(m.customer.addr)}`:''}</div>  
        </div>  
        <table class="w-full border-collapse text-sm">  
          <tr class="bg-gray-200"><th class="border p-1">#</th><th class="border p-1">ржкржгрзНржп</th><th class="border p-1">ржХрзЗржЬрж┐</th><th class="border p-1">ржкрж┐ржЫ</th><th class="border p-1">ржжрж╛ржо</th><th class="border p-1">ржорзЛржЯ</th></tr>  
          ${m.items.map((it,idx)=>`<tr><td class="border p-1 text-center">${idx+1}</td><td class="border p-1">${escapeHtml(it.name)} (${formatCategoryName(it.category || 'other')})</td><td class="border p-1 text-center">${fmt(it.kg)}</td><td class="border p-1 text-center">${it.pc}</td><td class="border p-1 text-right">рз│${fmt(it.price)}</td><td class="border p-1 text-right">рз│${fmt((it.kg*it.price + it.pc*it.price))}</td></tr>`).join('')}  
        </table>  
        <div class="text-right mt-2">  
          <p>ржбрж┐рж╕ржХрж╛ржЙржирзНржЯ: рз│${fmt(m.discount)}</p>  
          <p>ржкрж░рж┐рж╢рзЛржзрж┐ржд: рз│${fmt(m.paid)}</p>  
          <p class="font-bold">ржмрж╛ржХрж┐: рз│${fmt(m.due)}</p>  
          <p class="font-bold text-lg mt-1">ржорзЛржЯ: рз│${fmt(m.total)}</p>  
        </div>  
        <div class="flex justify-end gap-2 mt-3">  
          <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="printMemo(${m.id}, ${isHistory})">ЁЯЦия╕П ржкрзНрж░рж┐ржирзНржЯ</button>  
          <button class="bg-indigo-600 text-white px-3 py-1 rounded" onclick="pdfMemo(${m.id}, ${isHistory})">ЁЯУД PDF</button>  
          ${cancelButtonHtml || ''}
          ${deleteButtonHtml || ''}
          ${permanentDeleteButtonHtml || ''}
        </div>  
      `;  
      setTimeout(()=> window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 120);  
  }  
    
  // renderHistory ржлрж╛ржВрж╢ржи ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ
  function renderHistory(memoArray, targetDiv, mode){  
      targetDiv.innerHTML = '';  
      
      if(!memoArray.length){ 
          targetDiv.innerHTML = `<p class="text-center text-gray-500">ржХрзЛржирзЛ ${mode === 'active' ? 'рж╕ржХрзНрж░рж┐ржпрж╝' : 'ржкрзБрж░рзЛржирзЛ'} ржорзЗржорзЛ ржирзЗржЗ</p>`; 
          return; 
      }  
      
      memoArray.slice().reverse().forEach(m=>{  
        const div = document.createElement('div');  
        div.className = `border p-2 rounded ${mode === 'active' ? 'bg-gray-50' : 'bg-orange-50 border-orange-200'} flex justify-between items-center`;  
        
        const profitDisplay = secretsVisible ? `(рж▓рж╛ржн: рз│${fmt(m.totalProfit||0)})` : '';
        const historyText = mode === 'history' ? '(ржкрзБрж░рзЛржирзЛ)' : '';
        
        // ржмрж╛ржЯржи рждрзИрж░рж┐
        const viewButton = document.createElement('button');
        viewButton.className = "bg-blue-600 text-white px-2 py-1 rounded text-xs";
        viewButton.textContent = 'ржжрзЗржЦрзБржи';
        viewButton.onclick = ()=> showMemo(m, mode === 'history'); // Pass isHistory flag

        const printButton = document.createElement('button');
        printButton.className = "bg-green-600 text-white px-2 py-1 rounded text-xs";
        printButton.textContent = 'ЁЯЦия╕П';
        printButton.onclick = ()=> printMemo(m.id, mode === 'history');

        const pdfButton = document.createElement('button');
        pdfButton.className = "bg-indigo-600 text-white px-2 py-1 rounded text-xs";
        pdfButton.textContent = 'ЁЯУД';
        pdfButton.onclick = ()=> pdfMemo(m.id, mode === 'history');
        
        // Active Memos-ржПрж░ ржЬржирзНржп ржмрж╛рждрж┐рж▓ ржмрж╛ржЯржи (Delete/Restore Stock)
        let actionButton;
        if (mode === 'active') {
             actionButton = document.createElement('button');
             actionButton.className = `bg-red-500 text-white px-2 py-1 rounded text-xs ml-1 ${secretsVisible ? '' : 'hidden'}`;
             actionButton.textContent = 'тЖйя╕П ржмрж╛рждрж┐рж▓';
             actionButton.onclick = ()=> cancelMemo(m.id);
        } else if (mode === 'history') {
             // Permanent Save/Delete Button for History Memos
             actionButton = document.createElement('button');
             actionButton.className = `bg-red-800 text-white px-2 py-1 rounded text-xs ml-1 ${secretsVisible ? '' : 'hidden'}`;
             actionButton.textContent = 'ЁЯЧСя╕П рж╕рзНржерж╛рзЯрзАржнрж╛ржмрзЗ ржбрж┐рж▓рж┐ржЯ';
             actionButton.onclick = ()=> deleteMemoPermanentlyFromHistory(m.id);
        }

        div.innerHTML = `<div><p class="font-semibold">ржорзЗржорзЛ ${m.serial} ${historyText} тАФ рз│${fmt(m.total)} ${profitDisplay}</p><p class="text-xs text-gray-500">${m.date}</p></div>  
          <div class="flex gap-2 items-center">  
          </div>`;  
        
        // ржмрж╛ржЯржиржЧрзБрж▓рзЛ ржпрзЛржЧ ржХрж░рж╛
        const actionContainer = div.querySelector('.flex.gap-2');
        actionContainer.appendChild(viewButton);
        actionContainer.appendChild(printButton);
        actionContainer.appendChild(pdfButton);
        if (actionButton) {
            actionContainer.appendChild(actionButton);
        }

        targetDiv.appendChild(div);  
      });  
  }  
  
  // Permanent History Modal Logic
  showPermanentHistoryButton.addEventListener('click', () => {
      if (secretsVisible) {
          renderHistory(memoHistory, permanentMemoHistoryDiv, 'history');
          permanentHistoryModal.classList.remove('hidden');
      } else {
          alert("ржкрзБрж░рзЛржирзЛ ржЗрждрж┐рж╣рж╛рж╕ ржжрзЗржЦрждрзЗ рж╣рж▓рзЗ ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
      }
  });

  document.getElementById('closePermanentHistoryModal').addEventListener('click', () => permanentHistoryModal.classList.add('hidden'));
  permanentHistoryModal.addEventListener('click', (ev) => {
      if (ev.target === permanentHistoryModal) permanentHistoryModal.classList.add('hidden');
  });
  
  // *************************************************************
  // рзз ржмржЫрж░ ржкрж░ ржкрж░ ржкрзБрж░рзЛржирзЛ ржорзЗржорзЛ ржорзБржЫрзЗ ржлрзЗрж▓рж╛рж░ ржлрж╛ржВрж╢ржи (NEW)
  // *************************************************************
  function autoDeleteOldHistory() {
      const oneYearAgo = Date.now() - (365 * 24 * 60 * 60 * 1000); // 1 year in milliseconds
      let deletedCount = 0;

      // Filter out memos older than 1 year
      const newHistory = memoHistory.filter(m => {
          // Parse the date saved in "DD/MM/YYYY, HH:MM:SS PM" format
          // Recreate Date object based on the saved string (assuming it's a valid locale string)
          const memoDate = new Date(m.date);
          
          if (isNaN(memoDate.getTime())) {
              // Fallback for badly formatted dates (keep them if date is invalid)
              return true;
          }
          
          if (memoDate.getTime() < oneYearAgo) {
              deletedCount++;
              return false; // Delete this memo
          }
          return true; // Keep this memo
      });

      if (deletedCount > 0) {
          memoHistory = newHistory;
          saveMemoHistory();
          console.log(`тЬЕ ${deletedCount} ржЯрж┐ ржкрзБрж░рзЛржирзЛ ржорзЗржорзЛ ржЗрждрж┐рж╣рж╛рж╕ ржерзЗржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯрзЗржЫрзЗ (рзз ржмржЫрж░рзЗрж░ ржмрзЗрж╢рж┐ ржкрзБрж░рзЛржирзЛ)ред`);
          // Optionally, alert the user only if they are logged in
          if (secretsVisible) {
             alert(`тЬЕ ${deletedCount} ржЯрж┐ ржкрзБрж░рзЛржирзЛ ржорзЗржорзЛ ржЗрждрж┐рж╣рж╛рж╕ ржерзЗржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯрзЗржЫрзЗ (рзз ржмржЫрж░рзЗрж░ ржмрзЗрж╢рж┐ ржкрзБрж░рзЛржирзЛ)ред`);
          }
      }
  }


  // clear all qtys  
  document.getElementById('clearQty').addEventListener('click', ()=> {  
    if(!confirm('рж╕ржм ржкрзНрж░рзЛржбрж╛ржХрзНржЯрзЗрж░ ржкрж░рж┐ржорж╛ржг рж░рж┐рж╕рзЗржЯ ржХрж░ржмрзЗржи?')) return;  
    products.forEach(p=>{ p.kg = 0; p.pc = 0; });  
    document.getElementById('custName').value = '';  
    document.getElementById('custPhone').value = '';  
    document.getElementById('custAddr').value = ''; 
    discountInput.value = ''; paidInput.value = ''; dueInput.value = '';  
    saveProducts(); renderProducts(); updateSummary();  
  });  
  
  // search  
  searchInput.addEventListener('input', e=> renderProducts(e.target.value));  

  // Report Modal Logic (MODIFIED: Profit is calculated from memos + memoHistory)
  document.getElementById('openReport').addEventListener('click', () => {
      // Check if visible
      if (!secretsVisible) {
          alert("рж░рж┐ржкрзЛрж░рзНржЯ ржжрзЗржЦрждрзЗ рж╣рж▓рзЗ ржЖржкржирж╛ржХрзЗ ржЕржмрж╢рзНржпржЗ ржкрзНрж░ржержорзЗ ржЙржкрж░рзЗ ржерж╛ржХрж╛ рж▓ржХ ржмрж╛ржЯржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЧрзЛржкржирзАржпрж╝ ржЕржВрж╢ржЧрзБрж▓рзЛ ржЖржирж▓ржХ ржХрж░рждрзЗ рж╣ржмрзЗред");
          return;
      } else {
          openReportModal();
      }
  });
  document.getElementById('closeReport').addEventListener('click', () => reportModal.classList.add('hidden'));

  function openReportModal() {
      // This is only called if secrets are visible
      renderReports();
      reportModal.classList.remove('hidden');
      
      // Attach listeners after rendering the report content
      const expenseFormModal = document.getElementById('addExpenseFormModal');
      if (expenseFormModal) {
          expenseFormModal.addEventListener('submit', handleExpenseSubmission);
      }
      
      document.querySelectorAll('.delete-expense-in-modal').forEach(b => {
          b.addEventListener('click', (e) => {
              const id = parseInt(e.currentTarget.dataset.id);
              deleteExpense(id); // Use the refactored delete function
          });
      });
  }

  function renderReports() {
      // Get all memos for comprehensive reporting
      const allMemos = [...memos, ...memoHistory];
      
      // **1. Expense Logging Form and Daily History**
      let expenseLoggingAndDailyHistory = generateDailyExpenseHtml();
      
      // Filter out dummy products from report
      const realProducts = products.filter(p => !p.name.startsWith('__CATEGORY_'));

      // 2. Inventory Report 
      let inventoryHtml = '<h4 class="font-bold text-lg border-b pb-1">ржЗржиржнрзЗржирзНржЯрж░рж┐ рж░рж┐ржкрзЛрж░рзНржЯ (ржмрж░рзНрждржорж╛ржи ржоржЬрзБржж)</h4>';
      inventoryHtml += '<ul class="list-disc list-inside space-y-1 text-sm">';
      const inStock = realProducts.filter(p => p.stock > 0).sort((a,b)=> a.name.localeCompare(b.name));
      if (inStock.length > 0) {
          inventoryHtml += inStock.map(p => {
              // Always render secret info here as this function is only called when secretsVisible is true
              const secretText = secretsVisible ? 
                  ` (<span class="text-red-700">ржХрзЗржирж╛рж░ ржжрж╛ржо: рз│${fmt(p.costPrice||0)}</span> | ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо: рз│${fmt(p.price)} | ржкрзНрж░рждрж┐ ржЗржЙржирж┐ржЯ рж▓рж╛ржн: рз│${fmt(p.profitRate)})` :
                  ` (ржмрж┐ржХрзНрж░рзЯ ржжрж╛ржо: рз│${fmt(p.price)})`; 
              return `<li>**${escapeHtml(p.name)}** (${formatCategoryName(p.category || 'other')}, ржоржЬрзБржж): **${fmt(p.stock)}** ржЗржЙржирж┐ржЯ${secretText}</li>`;
          }).join('');
      } else {
          inventoryHtml += '<li>тЪая╕П ржХрзЛржирзЛ ржкрзНрж░рзЛржбрж╛ржХрзНржЯ ржоржЬрзБржд ржирзЗржЗред</li>';
      }
      inventoryHtml += '</ul>';

      // Profit Calculation (from ALL memos)
      let dailyProfit = 0;
      let monthlyProfit = 0;
      let grandTotalProfit = 0; 
      let grandTotalSale = 0; 
      let grandTotalDue = 0; 

      allMemos.forEach(m => {
          // Date parsing logic remains same (from previous version)
          const parts = m.date.split(', ');
          const datePart = parts[0].split('/'); 
          
          let memoDate;
          try {
             memoDate = new Date(m.date);
             if(isNaN(memoDate.getTime())) {
                const [d, mo, y] = datePart;
                memoDate = new Date(`${mo}/${d}/${y} ${parts[1]}`);
             }
          } catch(e) {
             memoDate = new Date(); 
          }
          
          const memoTotalProfit = m.totalProfit || 0;
          const memoTotalSale = m.total || 0; 
          
          grandTotalProfit += memoTotalProfit; 
          grandTotalSale += memoTotalSale; 
          grandTotalDue += m.due || 0; 
          
          if (memoDate.toDateString() === new Date().toDateString()) {
              dailyProfit += memoTotalProfit;
          }

          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();
          if (memoDate.getMonth() === currentMonth && memoDate.getFullYear() === currentYear) {
              monthlyProfit += memoTotalProfit;
          }
      });
      
      // Expense Calculations
      let totalStoreExpense = 0;
      let totalWithdrawal = 0;
      let totalFamilyExpense = 0;
      let totalPersonalExpense = 0;
      let grandTotalExpense = 0;

      expenses.forEach(e => {
          grandTotalExpense += e.amount;
          switch(e.category) {
              case 'store':
                  totalStoreExpense += e.amount;
                  break;
              case 'withdrawal':
                  totalWithdrawal += e.amount;
                  break;
              case 'family':
                  totalFamilyExpense += e.amount;
                  break;
              case 'personal':
                  totalPersonalExpense += e.amount;
                  break;
          }
      });
      
      // Conditional Profit Display in Report (Only runs if secretsVisible)
      let profitHtml = '';
      let memoProfitHtml = '';
      let expenseReportHtml = ''; 

      if (secretsVisible) {
          profitHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-4">рж▓рж╛ржн рж░рж┐ржкрзЛрж░рзНржЯ (ржорзЛржЯ рж╣рж┐рж╕рж╛ржм)</h4>';
          profitHtml += `<div class="grid grid-cols-3 gap-2 text-center">
              <div class="bg-green-100 p-2 rounded-lg">
                  <p class="text-sm">ржжрзИржирж┐ржХ рж▓рж╛ржн (${new Date().toLocaleDateString('bn-BD', { day: 'numeric', month: 'short' })})</p>
                  <h5 class="font-bold text-xl text-green-700">рз│${fmt(dailyProfit)}</h5>
              </div>
              <div class="bg-green-100 p-2 rounded-lg col-span-2">
                  <p class="text-sm">ржорж╛рж╕рж┐ржХ рж▓рж╛ржн (${new Date().toLocaleDateString('bn-BD', { month: 'long', year: 'numeric' })})</p>
                  <h5 class="font-bold text-xl text-green-700">рз│${fmt(monthlyProfit)}</h5>
              </div>
          </div>`;

          memoProfitHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-4">ржорзЗржорзЛ ржЕржирзБрж╕рж╛рж░рзЗ рж▓рж╛ржн рж░рж┐ржкрзЛрж░рзНржЯ (рж╕ржХрж▓ ржорзЗржорзЛ)</h4>';
          
          if (allMemos.length > 0) {
              memoProfitHtml += '<table class="w-full border-collapse text-sm mt-2">';
              memoProfitHtml += '<thead><tr class="bg-gray-200"><th class="border p-1">ржорзЗржорзЛ ржиржВ ржУ рждрж╛рж░рж┐ржЦ</th><th class="border p-1">ржорзЛржЯ ржмрж┐ржХрзНрж░рж┐ (рз│)</th><th class="border p-1">рж▓рж╛ржнрзЗрж░ ржкрж░рж┐ржорж╛ржг (рз│)</th></tr></thead>'; 
              memoProfitHtml += '<tbody>';

              allMemos.slice().reverse().forEach(m => {
                  const profit = m.totalProfit || 0;
                  const sale = m.total || 0; 
                  
                  const parts = m.date.split(', ');
                  const datePart = parts[0].split('/'); 
                  
                  let memoDate;
                  try {
                    memoDate = new Date(m.date);
                    if(isNaN(memoDate.getTime())) {
                       const [d, mo, y] = datePart;
                       memoDate = new Date(`${mo}/${d}/${y} ${parts[1]}`);
                    }
                  } catch(e) {
                     memoDate = new Date(); 
                  }
                  
                  const isToday = memoDate.toDateString() === new Date().toDateString();
                  
                  let rowClass = isToday ? 'bg-red-50 font-semibold border-2 border-red-500' : '';
                  const isHistory = memoHistory.some(h => h.id === m.id);
                  if (isHistory) rowClass = 'bg-orange-100 text-orange-800 italic border-orange-500';

                  const todayMark = isToday ? ' ЁЯФ┤ (ржЖржЬржХрзЗрж░)' : '';
                  const historyMark = isHistory ? ' ЁЯЧУя╕П (ржЗрждрж┐рж╣рж╛рж╕)' : '';


                  memoProfitHtml += `<tr class="${rowClass}"><td class="border p-1 text-center">ржорзЗржорзЛ ${m.serial} ${todayMark} ${historyMark}</td><td class="border p-1 text-right text-blue-600">рз│${fmt(sale)}</td><td class="border p-1 text-right text-green-600">рз│${fmt(profit)}</td></tr>`;
              });

              memoProfitHtml += '</tbody></table>';
              
              memoProfitHtml += `<div class="grid grid-cols-3 gap-2 mt-4 text-center">
                  <div class="bg-blue-100 p-2 rounded-lg border border-blue-400">
                      <p class="text-sm font-semibold">рж╕ржХрж▓ ржорзЗржорзЛрж░ ржорзЛржЯ ржмрж┐ржХрзНрж░рж┐</p>
                      <h5 class="font-bold text-xl text-blue-800">рз│${fmt(grandTotalSale)}</h5>
                  </div>
                  <div class="bg-green-100 p-2 rounded-lg border border-green-400">
                      <p class="text-sm font-semibold">рж╕ржХрж▓ ржорзЗржорзЛрж░ ржорзЛржЯ рж▓рж╛ржн</p>
                      <h5 class="font-bold text-xl text-green-800">рз│${fmt(grandTotalProfit)}</h5>
                  </div>
                  <div class="bg-yellow-100 p-2 rounded-lg border border-yellow-400">
                      <p class="text-sm font-semibold">ржорзЛржЯ ржмржХрзЗрзЯрж╛</p>
                      <h5 class="font-bold text-xl text-yellow-800">рз│${fmt(grandTotalDue)}</h5>
                  </div>
              </div>`;

          } else {
              memoProfitHtml += '<p class="text-sm text-gray-500 mt-2">ржХрзЛржирзЛ ржорзЗржорзЛ рждрзИрж░рж┐ рж╣рзЯржирж┐ред</p>';
          }
          
          // Expense Report HTML
          expenseReportHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-6 text-red-700">ЁЯТ╕ ржЦрж░ржЪрзЗрж░ рж╕рж╛рж░рж╛ржВрж╢ (Expense Summary)</h4>';
          expenseReportHtml += `<div class="grid grid-cols-2 gap-2 text-center mt-2">
              <div class="bg-red-100 p-2 rounded-lg border border-red-400">
                  <p class="text-sm font-semibold">ржжрзЛржХрж╛ржи ржерзЗржХрзЗ ржорзЛржЯ рждрзЛрж▓рж╛</p>
                  <h5 class="font-bold text-xl text-red-800">рз│${fmt(totalWithdrawal)}</h5>
              </div>
              <div class="bg-yellow-100 p-2 rounded-lg border border-yellow-400">
                  <p class="text-sm font-semibold">ржорзЛржЯ ржжрзЛржХрж╛ржирзЗрж░ ржЦрж░ржЪ</p>
                  <h5 class="font-bold text-xl text-yellow-800">рз│${fmt(totalStoreExpense)}</h5>
              </div>
              <div class="bg-indigo-100 p-2 rounded-lg border border-indigo-400">
                  <p class="text-sm font-semibold">ржорзЛржЯ ржмрзНржпржХрзНрждрж┐ржЧржд ржЦрж░ржЪ</p>
                  <h5 class="font-bold text-xl text-indigo-800">рз│${fmt(totalPersonalExpense)}</h5>
              </div>
              <div class="bg-purple-100 p-2 rounded-lg border border-purple-400">
                  <p class="text-sm font-semibold">ржорзЛржЯ ржкрж╛рж░рж┐ржмрж╛рж░рж┐ржХ ржЦрж░ржЪ</p>
                  <h5 class="font-bold text-xl text-purple-800">рз│${fmt(totalFamilyExpense)}</h5>
              </div>
              <div class="bg-gray-100 p-2 rounded-lg border border-gray-400 col-span-2">
                  <p class="text-sm font-semibold">рж╕ржХрж▓ ржкрзНрж░ржХрж╛рж░ **ржорзЛржЯ ржЦрж░ржЪ**</p>
                  <h5 class="font-bold text-xl text-gray-800">рз│${fmt(grandTotalExpense)}</h5>
              </div>
          </div>`;


      }

      // 3. DUE MEMOS REPORT (Always visible)
      const dueMemos = allMemos.filter(m => (m.due || 0) > 0);
      let dueMemosHtml = '<h4 class="font-bold text-lg border-b pb-1 mt-6 text-red-700">тЪая╕П ржмрж╛ржХрж┐ ржХрж╛рж╕рзНржЯржорж╛рж░ржжрзЗрж░ рждрж╛рж▓рж┐ржХрж╛ (Due Memos)</h4>';
      
      // Grand Total Due Display (Always visible)
      const grandTotalDueDisplay = `<div class="bg-red-100 p-2 rounded-lg mt-3 text-center border-2 border-red-500">
          <p class="text-sm font-semibold">рж╕ржХрж▓ ржорзЗржорзЛрж░ **ржорзЛржЯ ржмрж╛ржХрж┐**</p>
          <h5 class="font-bold text-xl text-red-700">рз│${fmt(grandTotalDue)}</h5>
      </div>`;
      
      dueMemosHtml += grandTotalDueDisplay;


      if (dueMemos.length > 0) {
          dueMemosHtml += '<table class="w-full border-collapse text-sm mt-4">';
          dueMemosHtml += '<thead><tr class="bg-red-100"><th class="border p-1">ржорзЗржорзЛ ржиржВ</th><th class="border p-1">ржХрж╛рж╕рзНржЯржорж╛рж░ (ржирж╛ржо/ржорзЛржмрж╛ржЗрж▓/ржарж┐ржХрж╛ржирж╛)</th><th class="border p-1">ржмрж╛ржХрж┐ ржЯрж╛ржХрж╛ (рз│)</th><th class="border p-1">ржпрзЛржЧрж╛ржпрзЛржЧ</th></tr></thead>';
          dueMemosHtml += '<tbody>';

          dueMemos.slice().reverse().forEach(m => {
              const customerName = escapeHtml(m.customer.name || 'ржирж╛ржо ржирзЗржЗ');
              const rawPhone = (m.customer.phone || '').replace(/[^0-9\+]/g, ''); 
              const customerPhone = escapeHtml(m.customer.phone || 'ржорзЛржмрж╛ржЗрж▓ ржирзЗржЗ');
              const customerAddr = escapeHtml(m.customer.addr || 'ржарж┐ржХрж╛ржирж╛ ржирзЗржЗ');
              const dueAmount = fmt(m.due);

              const message = encodeURIComponent(`ржкрзНрж░рж┐ржпрж╝ ${customerName}, ржЖржкржирж╛рж░ ржорзЗржорзЛ ржиржВ ${m.serial}-ржП рз│${dueAmount} ржЯрж╛ржХрж╛ ржмрж╛ржХрж┐ ржЖржЫрзЗред ржжржпрж╝рж╛ ржХрж░рзЗ ржпржд рждрж╛ржбрж╝рж╛рждрж╛ржбрж╝рж┐ рж╕ржорзНржнржм ржкрж░рж┐рж╢рзЛржз ржХрж░рзБржиред - RKB Store`);

              const phoneLink = `tel:${rawPhone}`;
              const smsLink = `sms:${rawPhone}?body=${message}`;
              const whatsappLink = `https://wa.me/${rawPhone}?text=${message}`;
              
              const isHistory = memoHistory.some(h => h.id === m.id);
              const rowClass = isHistory ? 'bg-orange-100 text-orange-800 italic border-orange-500' : '';

              dueMemosHtml += `<tr class="${rowClass}">
                  <td class="border p-1 text-center">${m.serial} ${isHistory ? 'ЁЯЧУя╕П' : ''}</td>
                  <td class="border p-1">
                      **${customerName}**<br>
                      <a href="${phoneLink}" class="text-blue-600 underline text-xs font-semibold">${customerPhone}</a> 
                      <span class="text-xs text-gray-500">(ржарж┐ржХрж╛ржирж╛: ${customerAddr})</span>
                  </td>
                  <td class="border p-1 text-right font-bold text-red-600">рз│${dueAmount}</td>
                  <td class="border p-1 text-center space-y-1">
                      <a href="${phoneLink}" class="bg-green-500 text-white px-2 py-1 rounded text-xs mb-1 block">ЁЯУЮ ржХрж▓</a>
                      <a href="${smsLink}" class="bg-blue-500 text-white px-2 py-1 rounded text-xs mb-1 block">ЁЯТм SMS</a>
                      <a href="${whatsappLink}" target="_blank" class="bg-purple-600 text-white px-2 py-1 rounded text-xs block">ЁЯУ▓ WhatsApp/Imo</a>
                  </td>
              </tr>`;
          });

          dueMemosHtml += '</tbody></table>';
          dueMemosHtml += `<p class="text-xs text-gray-500 mt-2">**ржжрзНрж░рж╖рзНржЯржмрзНржп:** 'WhatsApp/Imo' рж▓рж┐ржЩрзНржХрзЗ ржХрзНрж▓рж┐ржХ ржХрж░рж▓рзЗ ржЖржкржирж╛рж░ ржлрзЛржирзЗ ржЗржирж╕рзНржЯрж▓ ржерж╛ржХрж╛ ржЪрзНржпрж╛ржЯ ржЕрзНржпрж╛ржкрзЗ (ржпрзЗржоржи: WhatsApp) ржорзЗрж╕рзЗржЬржЯрж┐ ржХржкрж┐ рж╣рзЯрзЗ ржпрж╛ржмрзЗред</p>`;
      } else {
          dueMemosHtml += '<p class="text-sm text-green-600 mt-2">тЬЕ ржХрзЛржирзЛ ржорзЗржорзЛрждрзЗ ржмрж░рзНрждржорж╛ржирзЗ ржмрж╛ржХрж┐ ржирзЗржЗред</p>';
      }
      
      // Final render
      if (secretsVisible) {
          // New layout: Daily Expense Form/History at the top, then Inventory, then Profit/Memo, then Expense Summary, then Due Memos.
          reportContent.innerHTML = expenseLoggingAndDailyHistory + inventoryHtml + profitHtml + memoProfitHtml + expenseReportHtml + dueMemosHtml;
      } else {
          // If locked, only show non-sensitive reports (Inventory and Due Memos)
          reportContent.innerHTML = inventoryHtml + dueMemosHtml;
      }
  }
  // END Report Modal Logic
  
  // init  
  autoDeleteOldHistory(); // Run auto-deletion check on load
  updateSecretsVisibility(); // Initialize visibility based on stored state (calls renderProducts, renderHistory, updateSummary)
  
  // save on unload  
  window.addEventListener('beforeunload', ()=> { saveProducts(); saveMemos(); saveMemoHistory(); saveSerial(); saveSecretsState(); saveExpenses(); }); 
</script>  
</body>  
</html>
